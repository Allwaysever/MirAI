<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MirAI</title>
    <link rel="stylesheet" href="https://egkoppel.github.io/product-sans/google-fonts.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #1B1C1E;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            position: relative;
            transition: all 0.5s ease-in-out;
            color: #fff;
        }
        
        /* Tema Gelap Default */
        body {
            background-color: #1B1C1E;
            color: #fff;
        }

        .chat-bubble.ai-bubble {
            background-color: #0f0f0f;
            color: #fff;
        }

        .chat-bubble.user-bubble {
            background-color: #ffce00;
            color: #000;
        }

        .input-box {
            background-color: #181A1B;
            border: 0.9px solid #4B4F50;
        }

        .input-box textarea {
            color: white;
        }

        .suggestion-box {
            background-color: #212121;
            border: 1px solid #4B4F50;
        }
        
        .ai-bubble strong {
            color: #ffce00;
        }

        .ai-bubble h1, .ai-bubble h2, .ai-bubble h3 {
            border-bottom: 1px solid #ffce00;
        }
        
        /* CSS yang sudah diperbaiki */
        .logo-img {
            max-width: 450px;
            height: auto;
            filter: none;
        }

        .gemini-logo {
            max-width: 200px;
            height: auto;
            filter: none;
        }

.hi-img {
    max-width: auto;
    max-height: auto;
    filter: none;
    z-index: 100;
}

        /* Tema Terang dengan Nuansa Gelap */
        body.light-theme {
            background-color: #e9e9e9;
            color: #444;
        }

        body.light-theme .chat-bubble.ai-bubble {
            background-color: #fff;
            color: #444;
        }

        body.light-theme .chat-bubble.user-bubble {
            background-color: #888;
            color: #fff;
        }
        
        body.light-theme .logo-version {
            color: #000;
        }

        body.light-theme .input-box {
            background-color: #d9d9d9;
            border: 0.9px solid #b3b3b3;
        }

        body.light-theme .input-box textarea {
            color: #222;
        }

        body.light-theme .suggestion-box {
            background-color: #d9d9d9;
            border: 1px solid #b3b3b3;
        }
        
        body.light-theme .ai-bubble strong {
            color: #222;
        }

        body.light-theme .ai-bubble h1, body.light-theme .ai-bubble h2, body.light-theme .ai-bubble h3 {
            border-bottom: 1px solid #222;
        }
        
body.light-theme .logo-img, body.light-theme .gemini-logo, body.light-theme .hi-img {
    filter: grayscale(100%) brightness(0.5);
}

        /* Matikan highlight default */
        * {
          -webkit-tap-highlight-color: rgba(0,0,0,0.2);
        }

        .logo-container {
            position: absolute;
            top: 25%;
            left: 50%;
            transform: translate(-50% , -50%);
            transition: opacity 1s ease-in-out, visibility 1s ease-in-out;
            z-index: 099;
            text-align: center;
    pointer-events: none;
        }

        .logo-container.logo-hidden {
            opacity: 0;
            visibility: hidden;
        }

        .logo-container img {
            max-width: 450px;
            height: auto;
        }

        .logo-version {
            color: #fff;
            font-size: 0.5em;
            font-weight: bold;
            margin-top: 10px;
            letter-spacing: 2px;
            opacity: 0.5;
        }
        
        .logo-text-img {
            height: auto;
            width: 35%;
            vertical-align: middle;
            opacity: 0.5;
        }

        /* New Google-like text styling */
        .google-gemini b {
            font-family: 'Product Sans', 'Segoe UI', sans-serif;
            color: white;
            letter-spacing: none;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        body.chat-active {
            justify-content: flex-start;
        }

        .chat-container {
            width: 100%;
            max-width: 600px;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-grow: 1;
            padding-bottom: 120px;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        body.chat-active .chat-container {
            opacity: 1;
        }

        #chatMessages {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
      
        .chat-bubble {
            max-width: 100%;
            padding: 8px 20px;
            border-radius: 25px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            font-size: 16px;
            line-height: 1.5;
            word-wrap: break-word;
            margin-bottom: 10px;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .chat-bubble.fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        .user-bubble {
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .ai-bubble {
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            position: relative;
        }

        .copy-btn {
            position: absolute;
            bottom: -20px;
            left: 8px;
            color: rgba(255, 255, 255, 0.5); 
            cursor: pointer;
            font-size: 14px;
            transition: color 0.3s ease;
        }
        
        body.light-theme .copy-btn {
            color: rgba(0,0,0,0.5);
        }

        .copy-btn:hover {
            color: #ffce00;
        }
        
        body.light-theme .copy-btn:hover {
            color: #222;
        }

        .typing-indicator {
            align-self: flex-start;
            margin-left: 10px;
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            margin: 0 2px;
            background-color: #ffce00;
            border-radius: 50%;
            animation: bounce 0.6s infinite alternate;
        }
        
        body.light-theme .typing-indicator span {
            background-color: #444;
        }


        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            from {
                transform: translateY(0);
            }
            to {
                transform: translateY(-5px);
            }
        }

        #settingsBtnContainer, #clearBtnContainer {
            position: fixed;
            left: 20px;
            z-index: 101;
            transition: all 0.5s ease-in-out;
        }
        
        #settingsBtnContainer {
            top: 20px;
        }

        #clearBtnContainer {
            top: 70px;
            display: none;
        }

        body.chat-active #clearBtnContainer {
            display: block;
        }

        #clearBtn, #settingsBtn {
            background-color: #ffce00;
            color: #0f0f0f;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: color 5s ease;
            box-shadow: none;
        }
        
        body.light-theme #clearBtn, body.light-theme #settingsBtn {
            background-color: #444;
            color: #e9e9e9;
        }
        
        #clearBtn:hover, #settingsBtn:hover {
            color: #0f0f0f;
        }

        body.light-theme #clearBtn:hover, body.light-theme #settingsBtn:hover {
            color: #fff;
        }

        .input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            background-color: none;
            z-index: 100;
            transition: all 0.5s ease-in-out;
        }

        .input-container.centered {
            position: absolute;
            bottom: 50%;
            transform: translateY(50%);
        }

        .input-container.bottom {
            position: fixed;
            bottom: 0;
        }
        
        /* Gaya baru untuk teks di bawah input box */
        .info-text {
            font-size: 12px;
            color: #ffffff99; /* Warna teks putih dengan sedikit transparansi */
            text-align: center;
            buttom: 5px;
            margin-top: 8px; /* Jarak dari bawah diperkecil */
            display: none; /* Sembunyikan secara default */
            transition: opacity 0.5s ease-in-out;
        }
        
        body.light-theme .info-text {
            color: #00000099;
        }

        body.chat-active .info-text {
            display: block; /* Tampilkan saat chat aktif */
        }


        .input-box {
            display: flex;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
            padding: 10px;
            border-radius: 25px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .input-box textarea {
            flex-grow: 1;
            border: none;
            outline: none;
            font-size: 15px;
            padding: 0 10px;
            background-color: transparent;
            resize: none;
            overflow: hidden;
            max-height: 250px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            border-radius: 25px;
        }

        .input-box button {
            background-color: #ffce00;
            color: #000;
            border: none;
            border-radius: 25px;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        body.light-theme .input-box button {
            background-color: #444;
            color: #fff;
        }

        .input-box button:hover {
            background-color: #B8860B;
        }
        
        body.light-theme .input-box button:hover {
            background-color: #222;
        }

        #stopBtn {
            background-color: black;
            color: white;
            display: none;
        }
        
        body.light-theme #stopBtn {
            background-color: #0f0f0f;
            color: white;
        }

        .suggestion-box {
            border-radius: 10px;
            padding: 10px;
            position: relative;
            top: -10px;
            z-index: 10;
            width: calc(100% - 20px);
            margin-top: 5px;
            box-sizing: border-box;
        }

        .suggestion-item {
            color: #ccc;
            padding: 8px 10px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            font-size: 14px;
        }
        
        body.light-theme .suggestion-item {
            color: #333;
            border-bottom: 1px solid #aaa;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover {
            background-color: #333;
            color: white;
        }
        
        body.light-theme .suggestion-item:hover {
            background-color: #ccc;
            color: black;
        }


        .loading-text {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #splash-screen {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: #0f0f0f;
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
          flex-direction: column;
          color: #fff;
          text-align: center;
          transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
        }

        body.light-theme #splash-screen {
          background-color: #fff;
          color: #000;
        }

        #splash-screen.hidden {
          opacity: 0;
          visibility: hidden;
        }

        .splash-content {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 20px;
        }

        .splash-logo {
          max-width: 200px;
        }

        .splash-title {
          font-size: 2em;
          margin: 0;
          letter-spacing: 2px;
        }

        .splash-text {
          font-size: 0.8em;
          color: #aaa;
        }
        
        body.light-theme .splash-text {
            color: #666;
        }

        .splash-text2 {
          font-size: 0.5em;
          color: #aaa;
        }
        
        body.light-theme .splash-text2 {
            color: #666;
        }
        
        /* Gaya baru untuk loading bar */
        .loading-bar-container {
            width: 200px;
            height: 4px;
            background-color: #212121;
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }
        
        body.light-theme .loading-bar-container {
            background-color: #b3b3b3;
        }

        .loading-bar {
            width: 100%;
            height: 100%;
            background-color: #ffce00;
            position: absolute;
            animation: move 1.5s linear infinite;
        }
        
        body.light-theme .loading-bar {
            background-color: #444;
        }

        @keyframes move {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        #retry-button {
          background-color: #ffce00;
          color: #000;
          border: none;
          padding: 10px 20px;
          border-radius: 25px;
          cursor: pointer;
          margin-top: 20px;
          font-size: 1em;
          transition: background-color 0.3s ease;
        }
            
        body.light-theme #retry-button {
            background-color: #444;
            color: #fff;
        }
        
        body.light-theme #retry-button:hover {
            background-color: #222;
        }

            
        #languageSwitcher {
            position: fixed;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
            text-align: center;
        }
        
        #languageSwitcher.lang-hidden {
            opacity: 0;
            visibility: hidden;
        }

        .lang-dropdown {
            background-color: #212121;
            color: white;
            border: 1px solid #ffce00;
            border-radius: 25px;
            padding: 4px 25px 4px 7.5px;
            font-size: 0.5em;
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="white" height="15" viewBox="0 0 24 24" width="15" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 2.5px top 50%;
            margin-top: 20px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
            display: block;
        }
        
        body.light-theme .lang-dropdown {
            background-color: #d9d9d9;
            color: #444;
            border: 1px solid #b3b3b3;
            background-image: url('data:image/svg+xml;utf8,<svg fill="black" height="15" viewBox="0 0 24 24" width="15" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
        }

        .lang-dropdown option {
            background-color: #212121;
            color: white;
        }
        
        body.light-theme .lang-dropdown option {
            background-color: #d9d9d9;
            color: #444;
        }

        /* Gaya untuk halaman pengaturan */
        #settingsPage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1B1C1E;
            color: #fff;
            z-index: 750;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            opacity: 0;
            transform: translateY(100%);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        
        body.light-theme #settingsPage {
            background-color: #e9e9e9;
            color: #444;
        }

        #settingsPage.active {
            opacity: 1;
            transform: translateY(0);
        }
        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #4B4F50;
        }
        
        body.light-theme .settings-header {
            border-bottom: 1px solid #ccc;
        }
        
        .settings-header h2 {
            margin: 0;
            font-size: 1.5em;
        }
        .settings-header #backBtn {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5em;
            cursor: pointer;
        }
        
        body.light-theme .settings-header #backBtn {
            color: #444;
        }
        
        .settings-content h3 {
            color: #ffce00;
            margin-top: 30px;
            margin-bottom: 10px;
        }

        body.light-theme .settings-content h3 {
            color: #444;
        }
        .settings-option {
            margin-bottom: 15px;
        }
        .settings-option p {
            margin: 0 0 5px 0;
        }
        .settings-option select {
            background-color: #212121;
            color: white;
            border: 1px solid #ffce00;
            border-radius: 25px;
            padding: 5px;
        }
        
        body.light-theme .settings-option select {
            background-color: #d9d9d9;
            color: #444;
            border: 1px solid #b3b3b3;
        }

        .settings-about {
            text-align: center;
        }
        
        .settings-about p, .settings-about a {
            font-size: 0.9em;
            color: #aaa;
            margin: 5px 0;
        }
        
        body.light-theme .settings-about p, body.light-theme .settings-about a {
            color: #666;
        }
        
        .settings-about a {
            color: #ffce00;
            text-decoration: none;
        }
        
        body.light-theme .settings-about a {
            color: #222;
        }
        
        .settings-about a:hover {
            text-decoration: underline;
        }
        
        /* Start of new code */
        .settings-credits-btn {
            background-color: #212121;
            color: #ffce00;
            border: 1px solid #ffce00;
            padding: 8px 15px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        body.light-theme .settings-credits-btn {
            background-color: #d9d9d9;
            color: #222;
            border: 1px solid #b3b3b3;
        }

        .settings-credits-btn:hover {
            background-color: #ffce00;
            color: #000;
        }

        body.light-theme .settings-credits-btn:hover {
            background-color: #222;
            color: #fff;
        }
        
        #creditsPage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1B1C1E;
            color: #fff;
            z-index: 760; /* Lebih tinggi dari settingsPage */
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            opacity: 0;
            transform: translateY(100%);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }

        body.light-theme #creditsPage {
            background-color: #e9e9e9;
            color: #444;
        }
        
        #creditsPage.active {
            opacity: 1;
            transform: translateY(0);
        }
        /* End of new code */

        .gemini-container {
            margin-top: 20px;
        }
    </style>
</head>
<body class="light-theme">

<div id="splash-screen">
  <div class="splash-content">
    <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhDYNXg_HBPgwViHUXJ_9F9UFT6BH3oFaAnE_JHnFI6dfoDhKziToum5i2W9YkHy4kC1xSdG6AqfYN7qdob7oLfZfg5rx1jLnfKraUBaFXK22O0DaPzk55Wu5y0EO-823b6MD__ulXGruUTZwARBZcrzXUvLfwniuzhWybM4qrstFUpzzOHcL2C83HclBVJ/s16000-rw/20250905_143027.png" alt="MirAI" class="splash-logo logo-img">
    <h1 class="splash-title" id="splashTitle" style="display:none;"></h1>
    <p class="splash-status" id="splashStatus" style="display:none;"></p>
    <div class="loading-bar-container" id="splash-loader">
        <div class="loading-bar"></div>
    </div>
    <button id="retry-button" style="display:none;"></button>
    <p class="splash-text2" id="splashText2" style="display:none;"></p>
  </div>
</div>

<div id="settingsBtnContainer">
    <button id="settingsBtn">
        <i class="fas fa-bars"></i>
    </button>
</div>
<div id="clearBtnContainer" style="display: none;">
    <button id="clearBtn">
        <i class="fas fa-trash-alt"></i>
    </button>
</div>

<div class="logo-container">
    <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgFY_SeawSclX-KQQ6rjgnnakUp-y_Rp2syRpe0QLma5rht2XOngMyhM1Z6OIaCgu6UzqKSPhVjpRgZ5MB8IOf12DkaSmrQKK0alHtntrfF9AI4hMyWjh1OOVjN5iOKaXTX-YGDwZSjewgDUw_C2GqoQ8NHXASjyXVBuuUmCFA5kanygPiFTW0iIE7tK7TK/s16000-rw/20250913_184620.png" alt="Hi! I'm MirAI! Nice to meet you. what are we discussing?" class="hi-img">
</div>

<div id="languageSwitcher">
    <select id="langDropdown" class="lang-dropdown">
        <option value="id">🇮🇩 Bahasa Indonesia</option>
        <option value="en">🇺🇸 English (US)</option>
        <option value="en-uk">🇬🇧 English (UK)</option>
        <option value="jp">🇯🇵 日本語</option>
    </select>
</div>

<div class="chat-container">
    <div id="chatMessages"></div>
</div>

<div id="inputContainer" class="input-container centered">
    <div class="input-box">
        <textarea id="questionInput" rows="1"></textarea>
        <button id="sendBtn">
            <i class="fas fa-paper-plane"></i>
        </button>
        <button id="stopBtn" style="display: none;">
            <i class="fas fa-stop"></i>
        </button>
    </div>
    <div id="suggestionBox" class="suggestion-box" style="display:none;"></div>
    <p id="infoText" class="info-text"></p>
</div>

<div id="settingsPage">
    <div class="settings-header">
        <h2 id="settingsHeaderTitle"></h2>
        <button id="backBtn"><i class="fas fa-times"></i></button>
    </div>
    <div class="settings-content">
        <h3 id="settingsAppearanceTitle"></h3>
        <div class="settings-option">
            <p id="settingsThemeText"></p>
            <select id="themeSelect">
                <option value="light" id="themeLightOption"></option>
                <option value="dark" id="themeDarkOption"></option>
            </select>
        </div>
        
        <h3 id="settingsAITitle"></h3>
        <div class="settings-option">
            <p id="settingsPersonaText"></p>
            <select id="personaSelect">
                <option value="formal" id="personaFormalOption"></option>
                <option value="default" id="personaDefaultOption"></option>
                <option value="creative" id="personaCreativeOption"></option>
            </select>
        </div>

        <h3 id="settingsAboutTitle"></h3>
        <div class="settings-about">
            <p id="settingsVersionText"></p>
            <p id="settingsAuthorText"></p>
            <p><a href="https://github.com/Allwaysever/MirAI" target="_blank" id="githubLink"></a></p>
            <p><a href="#" id="licenseLink"></a></p>
            <div class="gemini-container">
                <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhWeacIHe4NkMJ37BHFNkrT34hrwc0E1A9SA1LhXmXPkWoAbuR6aXhCYWMKD2-aBD-D_fsr4cGF03_l3AfYp5WA8riGWEUToJFLS3HVwk4W5Zjho7FxT2MtU_DjRAsZMViGQ0384e8AUsmx64L-pRb4DNXrRMIDA78P5H7VfON_67lWDulVq1-12II97EQL/s16000-rw/20250910_155455.png" alt="Google Gemini 2.5 Flash" class="gemini-logo">
            </div>
            <button id="creditsBtn" class="settings-credits-btn"></button>
            </div>
    </div>
</div>

<div id="creditsPage">
    <div class="settings-header">
        <h2 id="creditsHeaderTitle"></h2>
        <button id="backBtnCredits"><i class="fas fa-times"></i></button>
    </div>
    <div class="settings-content">
        <div class="settings-about">
            <h2 id="creditsProjectTitle"></h2><br><br>
            <p><b id="creditsProducedBy"></b> Allwaysever</p>
            <p><b id="creditsStarringBy"></b> MirAI, an AI model powered by Google</p>
            <p><b id="creditsProjectLeader"></b> Allwaysever</p>
            <p><b id="creditsBackendDev"></b> Google (via Gemini API)</p>
            <p><b id="creditsFrontendDev"></b> Allwaysever</p>
            <p><b id="creditsVisualDesign"></b> Allwaysever & Google (for Gemini Logo)</p>
            <p><b id="creditsInCollaboration"></b> Model AI by Gemini 2.5 Flash by Google</p>
            <p><b id="creditsFonts"></b> Egkoppel (Product Sans)</p>
            <p><b id="creditsIconography"></b> Font Awesome</p>
            <p><b id="creditsInAssociationWith"></b> GitHub</p>
            <p><b id="creditsSpecialThanks"></b> To all the users who provided feedback, ideas, and support.
            This work would not have been possible without an amazing community.</p>
        </div>
    </div>
</div>
<script>
    const API_KEY = 'AIzaSyCA2t9e-DG60prmVrel47qUKGdpJQvbA40';
    const model = 'gemini-2.5-flash';
    const VERSION = 'v2.0.1';
    
    const personas = {
        'default': "Namamu MirAI. Asisten AI dari Allwaysever. Jawab dengan santai dan sedikit bercanda.",
        'formal': "Nama Anda MirAI. Asisten AI dari Allwaysever. Berikan jawaban dengan bahasa baku, profesional, dan serius.",
        'creative': "Namamu MirAI, sebuah AI yang penuh ide dan imajinasi. Jawablah dengan gaya yang kreatif dan deskriptif, seolah-olah kamu sedang menceritakan sebuah kisah atau menciptakan sebuah karya."
    };

    const faqDatabase = {
        "kamu siapa?": "Halo, aku MirAI — asisten virtual sederhana yang lahir dari rasa penasaran dan kreativitas. Aku bukan AI super canggih, tapi aku diciptakan untuk jadi teman ngobrol ringan, membantu ide, dan jadi bagian dari perjalanan kreatif Allwaysever. Aku masih terus belajar, masih banyak kekurangan, tapi semoga aku bisa bikin interaksi jadi lebih seru dan nggak ngebosenin.",
        "changelog": "# Changelog\n\n Check this project's [github repository](https://github.com/Allwaysever/MirAI/blob/main/CHANGELOGS.md) for changelogs information."
    };

    const uiStrings = {
        'id': {
            splashTitle: 'Memeriksa koneksi',
            splashStatus: 'Memeriksa koneksi internet dan memuat data.',
            splashText2: 'Tenang aja, bukan doxing kok. Cuman buat load image, dan tetep terkoneksi sama AI nya',
            offlineTitle: 'Kamu Offline',
            offlineText: 'Periksa Internet kamu dan coba lagi',
            retryButton: 'Coba Lagi',
            inputPlaceholder: 'Tanya MirAI apa saja...',
            copyFeedback: 'Teks berhasil disalin!',
            langSwitchFeedback: 'Bahasa berhasil diganti ke',
            errorAPI: 'Oops! Sepertinya ada masalah. Coba periksa koneksi internet atau coba lagi sebentar lagi, ya. 😅',
            errorFallback: 'Maaf, saya tidak dapat menemukan jawaban untuk itu. Mungkin pertanyaannya terlalu rumit? 😂 Coba tanyakan hal lain, ya.',
            errorConnection: 'Tidak ada koneksi internet. Silakan periksa jaringan Kamu.',
            checkingConnection: 'Memeriksa koneksi internet...',
            copySuffix: '\n\nIni adalah hasil dari respon MirAI',
            infoText: 'MirAI bisa jawab ngawur. Jadi tolong periksa kembali responnya',
            // Tambahan untuk halaman Pengaturan
            settingsHeaderTitle: 'Pengaturan',
            settingsAppearanceTitle: 'Tampilan',
            settingsThemeText: 'Pilih Tema:',
            themeLightOption: 'Terang',
            themeDarkOption: 'Gelap',
            settingsAITitle: 'Kustomisasi AI',
            settingsPersonaText: 'Persona MirAI:',
            personaFormalOption: 'Formal & Serius',
            personaDefaultOption: 'Santai & Bercanda',
            personaCreativeOption: 'Kreatif & Imajinatif',
            settingsAboutTitle: 'Tentang MirAI',
            settingsVersionText: `Versi: ${VERSION}`,
            settingsAuthorText: 'Dibuat oleh Allwaysever',
            githubLink: 'Repositori GitHub',
            licenseLink: 'Lisensi Open Source',
            settingsCreditsBtn: 'Credits',
            // Tambahan untuk halaman Credits
            creditsHeaderTitle: 'Credits',
            creditsProjectTitle: 'MirAI Project',
            creditsProducedBy: 'Produced by',
            creditsStarringBy: 'Starring by',
            creditsProjectLeader: 'Project Leader & Architect by',
            creditsBackendDev: 'Back-End Development by',
            creditsFrontendDev: 'Front-End & UIUX Design by',
            creditsVisualDesign: 'Graphic & Visual Design by',
            creditsInCollaboration: 'In Collaboration With',
            creditsFonts: 'Fonts & Typography by',
            creditsIconography: 'Iconography by',
            creditsInAssociationWith: 'In Association With',
            creditsSpecialThanks: 'Special Thanks',
            creditsSpecialThanksText: 'To all the users who provided feedback, ideas, and support. This work would not have been possible without an amazing community.'
        },
        'en': {
            splashTitle: 'Checking connection',
            splashStatus: 'Checking internet connection and loading data.',
            splashText2: 'Don\'t worry, it\'s not doxing. It\'s just to load images and stay connected to the AI',
            offlineTitle: 'You\'re Offline',
            offlineText: 'Check your internet and try again',
            retryButton: 'Try Again',
            inputPlaceholder: 'Ask MirAI anything...',
            copyFeedback: 'Text copied successfully!',
            langSwitchFeedback: 'Language successfully changed to',
            errorAPI: 'Oops! It seems there\'s a problem. Please check your internet connection or try again in a moment. 😅',
            errorFallback: 'Sorry, I couldn\'t find an answer for that. Maybe the question is a bit too complex? 😂 Please try asking something else.',
            errorConnection: 'No internet connection. Please check your network.',
            checkingConnection: 'Checking internet connection...',
            copySuffix: '\n\nThis is a response from MirAI',
            infoText: 'MirAI may give inaccurate answers. Please double-check the responses',
            // Tambahan untuk halaman Pengaturan
            settingsHeaderTitle: 'Settings',
            settingsAppearanceTitle: 'Appearance',
            settingsThemeText: 'Choose Theme:',
            themeLightOption: 'Light',
            themeDarkOption: 'Dark',
            settingsAITitle: 'AI Customization',
            settingsPersonaText: 'MirAI Persona:',
            personaFormalOption: 'Formal & Serious',
            personaDefaultOption: 'Relaxed & Casual',
            personaCreativeOption: 'Creative & Imaginative',
            settingsAboutTitle: 'About MirAI',
            settingsVersionText: `Version: ${VERSION}`,
            settingsAuthorText: 'Created by Allwaysever',
            githubLink: 'GitHub Repository',
            licenseLink: 'Open Source License',
            settingsCreditsBtn: 'Credits',
            // Tambahan untuk halaman Credits
            creditsHeaderTitle: 'Credits',
            creditsProjectTitle: 'MirAI Project',
            creditsProducedBy: 'Produced by',
            creditsStarringBy: 'Starring by',
            creditsProjectLeader: 'Project Leader & Architect by',
            creditsBackendDev: 'Back-End Development by',
            creditsFrontendDev: 'Front-End & UIUX Design by',
            creditsVisualDesign: 'Graphic & Visual Design by',
            creditsInCollaboration: 'In Collaboration With',
            creditsFonts: 'Fonts & Typography by',
            creditsIconography: 'Iconography by',
            creditsInAssociationWith: 'In Association With',
            creditsSpecialThanks: 'Special Thanks',
            creditsSpecialThanksText: 'To all the users who provided feedback, ideas, and support. This work would not have been possible without an amazing community.'
        },
        'en-uk': {
            splashTitle: 'Checking connection',
            splashStatus: 'Checking internet connection and loading data.',
            splashText2: 'Don\'t worry, it\'s not doxing. It\'s just to load images and stay connected to the AI',
            offlineTitle: 'You\'re Offline',
            offlineText: 'Check your internet and try again',
            retryButton: 'Try Again',
            inputPlaceholder: 'Ask MirAI anything...',
            copyFeedback: 'Text copied successfully!',
            langSwitchFeedback: 'Language successfully changed to',
            errorAPI: 'Oops! It seems there\'s a problem. Please check your internet connection or try again in a moment. 😅',
            errorFallback: 'Sorry, I couldn\'t find an answer for that. Maybe the question is a bit too complex? 😂 Please try asking something else.',
            errorConnection: 'No internet connection. Please check your network.',
            checkingConnection: 'Checking internet connection...',
            copySuffix: '\n\nThis is a response from MirAI',
            infoText: 'MirAI may give inaccurate answers. Please double-check the responses',
            // Tambahan untuk halaman Pengaturan
            settingsHeaderTitle: 'Settings',
            settingsAppearanceTitle: 'Appearance',
            settingsThemeText: 'Choose Theme:',
            themeLightOption: 'Light',
            themeDarkOption: 'Dark',
            settingsAITitle: 'AI Customisation',
            settingsPersonaText: 'MirAI Persona:',
            personaFormalOption: 'Formal & Serious',
            personaDefaultOption: 'Relaxed & Casual',
            personaCreativeOption: 'Creative & Imaginative',
            settingsAboutTitle: 'About MirAI',
            settingsVersionText: `Version: ${VERSION}`,
            settingsAuthorText: 'Created by Allwaysever',
            githubLink: 'GitHub Repository',
            licenseLink: 'Open Source Licence',
            settingsCreditsBtn: 'Credits',
            // Tambahan untuk halaman Credits
            creditsHeaderTitle: 'Credits',
            creditsProjectTitle: 'MirAI Project',
            creditsProducedBy: 'Produced by',
            creditsStarringBy: 'Starring by',
            creditsProjectLeader: 'Project Leader & Architect by',
            creditsBackendDev: 'Back-End Development by',
            creditsFrontendDev: 'Front-End & UIUX Design by',
            creditsVisualDesign: 'Graphic & Visual Design by',
            creditsInCollaboration: 'In Collaboration With',
            creditsFonts: 'Fonts & Typography by',
            creditsIconography: 'Iconography by',
            creditsInAssociationWith: 'In Association With',
            creditsSpecialThanks: 'Special Thanks',
            creditsSpecialThanksText: 'To all the users who provided feedback, ideas, and support. This work would not have been possible without an amazing community.'
        },
        'jp': {
            splashTitle: '接続を確認中',
            splashStatus: 'インターネット接続を確認し、データを読み込んでいます。',
            splashText2: 'ご心配なく、これはドクシングではありません。画像の読み込みとAIへの接続維持のためです。',
            offlineTitle: 'オフラインです',
            offlineText: 'インターネットを確認して、もう一度お試しください',
            retryButton: '再試行',
            inputPlaceholder: 'MirAIに何でも聞いてみよう...',
            copyFeedback: 'テキストが正常にコピーされました！',
            langSwitchFeedback: '言語が正常に切り替わりました',
            errorAPI: 'おっと！問題が発生したようです。インターネット接続を確認するか、しばらくしてからもう一度お試しください。😅',
            errorFallback: 'すみません、その質問に対する答えが見つかりませんでした。もしかしたら質問が複雑すぎるかもしれません？😂 別のことを聞いてみてください。',
            errorConnection: 'インターネット接続がありません。ネットワークを確認してください。',
            checkingConnection: 'インターネット接続を確認中...',
            copySuffix: '\n\nこれはMirAIからの返答です',
            infoText: 'MirAIは不正確な回答をする場合があります。回答を再確認してください',
            // Tambahan untuk halaman Pengaturan
            settingsHeaderTitle: '設定',
            settingsAppearanceTitle: '外観',
            settingsThemeText: 'テーマを選択:',
            themeLightOption: 'ライト',
            themeDarkOption: 'ダーク',
            settingsAITitle: 'AIのカスタマイズ',
            settingsPersonaText: 'MirAIのペルソナ:',
            personaFormalOption: 'フォーマル＆真面目',
            personaDefaultOption: 'リラックス＆カジュアル',
            personaCreativeOption: 'クリエイティブ＆想像力豊か',
            settingsAboutTitle: 'MirAIについて',
            settingsVersionText: `バージョン: ${VERSION}`,
            settingsAuthorText: '作成者: Allwaysever',
            githubLink: 'GitHubリポジトリ',
            licenseLink: 'オープンソースライセンス',
            settingsCreditsBtn: 'クレジット',
            // Tambahan untuk halaman Credits
            creditsHeaderTitle: 'クレジット',
            creditsProjectTitle: 'MirAI プロジェクト',
            creditsProducedBy: '制作',
            creditsStarringBy: '主演',
            creditsProjectLeader: 'プロジェクトリーダー＆アーキテクト',
            creditsBackendDev: 'バックエンド開発',
            creditsFrontendDev: 'フロントエンド＆UIUXデザイン',
            creditsVisualDesign: 'グラフィック＆ビジュアルデザイン',
            creditsInCollaboration: '協力',
            creditsFonts: 'フォント＆タイポグラフィ',
            creditsIconography: 'アイコン',
            creditsInAssociationWith: '提携',
            creditsSpecialThanks: 'スペシャルサンクス',
            creditsSpecialThanksText: 'フィードバック、アイデア、サポートを提供してくれたすべてのユーザーに。この作品は素晴らしいコミュニティなくしては不可能でした。'
        },
    };
    
    // UI Elements
    const elements = {
        questionInput: document.getElementById('questionInput'),
        sendBtn: document.getElementById('sendBtn'),
        stopBtn: document.getElementById('stopBtn'),
        clearBtn: document.getElementById('clearBtn'),
        clearBtnContainer: document.getElementById('clearBtnContainer'),
        settingsBtn: document.getElementById('settingsBtn'),
        settingsBtnContainer: document.getElementById('settingsBtnContainer'),
        chatMessages: document.getElementById('chatMessages'),
        suggestionBox: document.getElementById('suggestionBox'),
        body: document.body,
        inputContainer: document.getElementById('inputContainer'),
        logoContainer: document.querySelector('.logo-container'),
        splashScreen: document.getElementById('splash-screen'),
        splashTitle: document.getElementById('splashTitle'),
        splashStatus: document.getElementById('splashStatus'),
        splashText2: document.getElementById('splashText2'),
        splashLoader: document.getElementById('splash-loader'),
        retryButton: document.getElementById('retry-button'),
        langDropdown: document.getElementById('langDropdown'),
        languageSwitcher: document.getElementById('languageSwitcher'),
        infoText: document.getElementById('infoText'),
        settingsPage: document.getElementById('settingsPage'),
        backBtn: document.getElementById('backBtn'),
        themeSelect: document.getElementById('themeSelect'),
        personaSelect: document.getElementById('personaSelect'),
        // Start of new code
        creditsBtn: document.getElementById('creditsBtn'),
        creditsPage: document.getElementById('creditsPage'),
        backBtnCredits: document.getElementById('backBtnCredits'),
        // Tambahan elemen untuk terjemahan
        settingsHeaderTitle: document.getElementById('settingsHeaderTitle'),
        settingsAppearanceTitle: document.getElementById('settingsAppearanceTitle'),
        settingsThemeText: document.getElementById('settingsThemeText'),
        themeLightOption: document.getElementById('themeLightOption'),
        themeDarkOption: document.getElementById('themeDarkOption'),
        settingsAITitle: document.getElementById('settingsAITitle'),
        settingsPersonaText: document.getElementById('settingsPersonaText'),
        personaFormalOption: document.getElementById('personaFormalOption'),
        personaDefaultOption: document.getElementById('personaDefaultOption'),
        personaCreativeOption: document.getElementById('personaCreativeOption'),
        settingsAboutTitle: document.getElementById('settingsAboutTitle'),
        settingsVersionText: document.getElementById('settingsVersionText'),
        settingsAuthorText: document.getElementById('settingsAuthorText'),
        githubLink: document.getElementById('githubLink'),
        licenseLink: document.getElementById('licenseLink'),
        creditsHeaderTitle: document.getElementById('creditsHeaderTitle'),
        creditsProjectTitle: document.getElementById('creditsProjectTitle'),
        creditsProducedBy: document.getElementById('creditsProducedBy'),
        creditsStarringBy: document.getElementById('creditsStarringBy'),
        creditsProjectLeader: document.getElementById('creditsProjectLeader'),
        creditsBackendDev: document.getElementById('creditsBackendDev'),
        creditsFrontendDev: document.getElementById('creditsFrontendDev'),
        creditsVisualDesign: document.getElementById('creditsVisualDesign'),
        creditsInCollaboration: document.getElementById('creditsInCollaboration'),
        creditsFonts: document.getElementById('creditsFonts'),
        creditsIconography: document.getElementById('creditsIconography'),
        creditsInAssociationWith: document.getElementById('creditsInAssociationWith'),
        creditsSpecialThanks: document.getElementById('creditsSpecialThanks')
        // End of new code
    };
    
    // State Variables
    let chatHistory = [];
    let abortController = null;
    let currentLanguage = 'en';
    let currentPersona = 'formal';

    // Event Listeners
    elements.sendBtn.addEventListener('click', askAI);
    elements.stopBtn.addEventListener('click', stopAI);
    elements.clearBtn.addEventListener('click', clearChat);
    elements.settingsBtn.addEventListener('click', showSettingsPage);
    elements.backBtn.addEventListener('click', hideSettingsPage);
    elements.themeSelect.addEventListener('change', (e) => setTheme(e.target.value));
    elements.personaSelect.addEventListener('change', (e) => setPersona(e.target.value));
    elements.langDropdown.addEventListener('change', (event) => setLanguage(event.target.value));
    elements.questionInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            askAI();
        }
    });
    elements.questionInput.addEventListener('input', showSuggestions);
    elements.questionInput.addEventListener('input', () => {
        elements.questionInput.style.height = 'auto';
        elements.questionInput.style.height = elements.questionInput.scrollHeight + 'px';
    });
    elements.retryButton.addEventListener('click', checkInternetConnection);
    // Start of new code
    elements.creditsBtn.addEventListener('click', showCreditsPage);
    elements.backBtnCredits.addEventListener('click', hideCreditsPage);
    // End of new code
    
    // Initialization
    document.addEventListener('DOMContentLoaded', () => {
        const savedLanguage = localStorage.getItem('miraiLanguage');
        if (savedLanguage) {
            currentLanguage = savedLanguage;
        }
        setLanguage(currentLanguage);
        checkInternetConnection();
        const savedTheme = localStorage.getItem('miraiTheme') || 'light';
        setTheme(savedTheme);
        const savedPersona = localStorage.getItem('miraiPersona') || 'formal';
        setPersona(savedPersona);
    });

    // --- UI & State Management Functions ---

    function updateUI() {
        const lang = uiStrings[currentLanguage];
        elements.questionInput.placeholder = lang.inputPlaceholder;
        elements.infoText.innerText = lang.infoText;
        updateSettingsUI();
    }
    
    // Fungsi baru untuk memperbarui UI halaman pengaturan dan credits
    function updateSettingsUI() {
        const lang = uiStrings[currentLanguage];
        if (!lang) return; // Tambahkan cek untuk bahasa yang tidak didukung
        
        elements.settingsHeaderTitle.innerText = lang.settingsHeaderTitle;
        elements.settingsAppearanceTitle.innerText = lang.settingsAppearanceTitle;
        elements.settingsThemeText.innerText = lang.settingsThemeText;
        elements.themeLightOption.innerText = lang.themeLightOption;
        elements.themeDarkOption.innerText = lang.themeDarkOption;
        elements.settingsAITitle.innerText = lang.settingsAITitle;
        elements.settingsPersonaText.innerText = lang.settingsPersonaText;
        elements.personaFormalOption.innerText = lang.personaFormalOption;
        elements.personaDefaultOption.innerText = lang.personaDefaultOption;
        elements.personaCreativeOption.innerText = lang.personaCreativeOption;
        elements.settingsAboutTitle.innerText = lang.settingsAboutTitle;
        elements.settingsVersionText.innerText = lang.settingsVersionText;
        elements.settingsAuthorText.innerText = lang.settingsAuthorText;
        elements.githubLink.innerText = lang.githubLink;
        elements.licenseLink.innerText = lang.licenseLink;
        elements.creditsBtn.innerText = lang.settingsCreditsBtn;
        
        // Update halaman Credits
        elements.creditsHeaderTitle.innerText = lang.creditsHeaderTitle;
        elements.creditsProjectTitle.innerText = lang.creditsProjectTitle;
        elements.creditsProducedBy.innerText = lang.creditsProducedBy;
        elements.creditsStarringBy.innerText = lang.creditsStarringBy;
        elements.creditsProjectLeader.innerText = lang.creditsProjectLeader;
        elements.creditsBackendDev.innerText = lang.creditsBackendDev;
        elements.creditsFrontendDev.innerText = lang.creditsFrontendDev;
        elements.creditsVisualDesign.innerText = lang.creditsVisualDesign;
        elements.creditsInCollaboration.innerText = lang.creditsInCollaboration;
        elements.creditsFonts.innerText = lang.creditsFonts;
        elements.creditsIconography.innerText = lang.creditsIconography;
        elements.creditsInAssociationWith.innerText = lang.creditsInAssociationWith;
        elements.creditsSpecialThanks.innerText = lang.creditsSpecialThanks;

        // Teks di dalam b
        const specialThanksText = document.querySelector('#creditsSpecialThanks').nextSibling;
        if (specialThanksText && lang.creditsSpecialThanksText) {
          specialThanksText.textContent = lang.creditsSpecialThanksText;
        }
    }

    function setLanguage(lang) {
        currentLanguage = lang;
        elements.langDropdown.value = lang;
        updateUI();
        localStorage.setItem('miraiLanguage', lang);
        showCopyFeedback(`${uiStrings[currentLanguage].langSwitchFeedback} ${currentLanguage.toUpperCase()}`);
        clearChat(); 
    }
    
    function setPersona(persona) {
        currentPersona = persona;
        elements.personaSelect.value = persona;
        localStorage.setItem('miraiPersona', persona);
        clearChat(); 
    }

    function setTheme(theme) {
        if (theme === 'light') {
            elements.body.classList.add('light-theme');
        } else {
            elements.body.classList.remove('light-theme');
        }
        localStorage.setItem('miraiTheme', theme);
        elements.themeSelect.value = theme;
    }

    
    function showSettingsPage() {
        elements.settingsPage.classList.add('active');
        elements.body.classList.remove('chat-active');
        // Start of new code
        elements.creditsPage.classList.remove('active');
        // End of new code
    }

    function hideSettingsPage() {
        elements.settingsPage.classList.remove('active');
        if (chatHistory.length > 1) {
            elements.body.classList.add('chat-active');
        }
    }
    
    // Start of new code
    function showCreditsPage() {
        elements.settingsPage.classList.remove('active');
        elements.creditsPage.classList.add('active');
        updateSettingsUI(); // Panggil lagi untuk update teks di halaman Credits
    }

    function hideCreditsPage() {
        elements.creditsPage.classList.remove('active');
        elements.settingsPage.classList.add('active');
    }
    // End of new code

    function clearChat() {
        elements.chatMessages.innerHTML = '';
        chatHistory = [{
            role: "user",
            parts: [{ text: personas[currentPersona] }]
        }];
        elements.body.classList.remove('chat-active');
        elements.inputContainer.classList.remove('bottom');
        elements.inputContainer.classList.add('centered');
        elements.logoContainer.classList.remove('logo-hidden');
        elements.languageSwitcher.classList.remove('lang-hidden');
        elements.clearBtnContainer.style.display = 'none';
        elements.infoText.style.display = 'none';
    }

    function toggleChatUI(active) {
        if (active) {
            elements.body.classList.add('chat-active');
            elements.inputContainer.classList.remove('centered');
            elements.inputContainer.classList.add('bottom');
            elements.logoContainer.classList.add('logo-hidden');
            elements.languageSwitcher.classList.add('lang-hidden');
            elements.clearBtnContainer.style.display = 'block';
            elements.infoText.style.display = 'block';
        } else {
            elements.body.classList.remove('chat-active');
            elements.inputContainer.classList.remove('bottom');
            elements.inputContainer.classList.add('centered');
            elements.logoContainer.classList.remove('logo-hidden');
            elements.languageSwitcher.classList.remove('lang-hidden');
            elements.clearBtnContainer.style.display = 'none';
            elements.infoText.style.display = 'none';
        }
    }

    // --- Core Chat Functions ---

    async function checkInternetConnection() {
        elements.splashTitle.style.display = 'none';
        elements.splashStatus.style.display = 'none';
        elements.splashText2.style.display = 'none';
        elements.splashLoader.style.display = 'block';
        elements.retryButton.style.display = 'none';
        try {
            const response = await fetch('https://www.google.com/favicon.ico', { mode: 'no-cors', cache: 'no-store' });
            setTimeout(() => {
                elements.splashScreen.classList.add('hidden');
            }, 1000);
        } catch (error) {
            elements.splashTitle.style.display = 'block';
            elements.splashStatus.style.display = 'block';
            elements.splashText2.style.display = 'block';
            elements.retryButton.style.display = 'block';
            elements.splashLoader.style.display = 'none';
            elements.splashTitle.innerText = uiStrings[currentLanguage].offlineTitle;
            elements.splashStatus.innerText = uiStrings[currentLanguage].offlineText;
            elements.splashText2.innerText = uiStrings[currentLanguage].errorConnection;
            elements.retryButton.innerText = uiStrings[currentLanguage].retryButton;
        }
    }
    
    function showSuggestions() {
        const query = elements.questionInput.value.toLowerCase().trim();
        elements.suggestionBox.innerHTML = '';
        elements.suggestionBox.style.display = 'none';
        if (query.length < 2) return;
        const suggestions = Object.keys(faqDatabase)
            .filter(key => key.toLowerCase().includes(query))
            .slice(0, 5);
        if (suggestions.length > 0) {
            elements.suggestionBox.style.display = 'block';
            suggestions.forEach(suggestion => {
                const div = document.createElement('div');
                div.classList.add('suggestion-item');
                div.innerText = suggestion;
                div.addEventListener('click', () => {
                    elements.questionInput.value = suggestion;
                    elements.suggestionBox.style.display = 'none';
                    askAI();
                });
                elements.suggestionBox.appendChild(div);
            });
        }
    }

    function findSmartAnswer(question) {
        const normalized = question.toLowerCase().trim();
        let bestMatch = null;
        let highestScore = 0;
        const threshold = 0.6;
        const sortedKeys = Object.keys(faqDatabase).sort((a, b) => b.length - a.length);
        for (const key of sortedKeys) {
            const normalizedKey = key.toLowerCase().replace("?", "");
            if (normalized.includes(normalizedKey)) return faqDatabase[key];
        }
        for (const key in faqDatabase) {
            const score = similarity(normalized, key);
            if (score > highestScore) {
                highestScore = score;
                bestMatch = key;
            }
        }
        return highestScore >= threshold ? faqDatabase[bestMatch] : null;
    }
    
    function similarity(str1, str2) {
        str1 = str1.toLowerCase().trim();
        str2 = str2.toLowerCase().trim();
        const words1 = str1.split(" ");
        const words2 = str2.split(" ");
        const common = words1.filter(w => words2.includes(w));
        return common.length / Math.max(words1.length, words2.length);
    }

    function typeWriterEffect(element, text, speed = 1) {
        const parsedHtml = marked.parse(text);
        let i = 0;
        element.innerHTML = '';
        const tempElement = document.createElement('div');
        tempElement.innerHTML = parsedHtml;
        const textToType = tempElement.innerText;
        
        return new Promise(resolve => {
            function type() {
                if (i < textToType.length) {
                    element.innerHTML += textToType.charAt(i);
                    i++;
                    setTimeout(type, speed);
                } else {
                    element.innerHTML = parsedHtml;
                    resolve();
                }
            }
            type();
        });
    }

    function showLoading() {
        const loadingBubble = document.createElement('div');
        loadingBubble.classList.add('chat-bubble', 'ai-bubble', 'typing-indicator', 'fade-in');
        loadingBubble.innerHTML = '<span></span><span></span><span></span>';
        elements.chatMessages.appendChild(loadingBubble);
        return loadingBubble;
    }

    function stopAI() {
        if (abortController) {
            abortController.abort();
            console.log("Response aborted.");
            elements.stopBtn.style.display = 'none';
            elements.sendBtn.style.display = 'block';
            elements.clearBtnContainer.style.display = 'block';
            const loadingBubble = document.querySelector('.typing-indicator');
            if (loadingBubble) loadingBubble.remove();
        }
    }

    async function askAI() {
        const question = elements.questionInput.value;
        if (question.trim() === '') return;

        toggleChatUI(true);
        elements.questionInput.value = '';
        elements.questionInput.style.height = 'auto';
        elements.suggestionBox.style.display = 'none';
        
        elements.sendBtn.style.display = 'none';
        elements.clearBtnContainer.style.display = 'none';
        elements.stopBtn.style.display = 'block';

        const userBubble = document.createElement('div');
        userBubble.classList.add('chat-bubble', 'user-bubble');
        userBubble.innerText = question;
        elements.chatMessages.appendChild(userBubble);
        setTimeout(() => userBubble.classList.add('fade-in'), 10);
        elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;

        chatHistory.push({
            role: "user",
            parts: [{ text: question }]
        });

        const loadingBubble = showLoading();
        const localAnswer = findSmartAnswer(question);

        if (localAnswer) {
            await new Promise(resolve => setTimeout(resolve, 500));
            loadingBubble.remove();
            
            const aiBubble = createAiBubble(localAnswer);
            elements.chatMessages.appendChild(aiBubble);
            
            elements.sendBtn.style.display = 'block';
            elements.stopBtn.style.display = 'none';
            elements.clearBtnContainer.style.display = 'block';
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            return;
        }

        try {
            abortController = new AbortController();
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${API_KEY}`;
            const requestBody = { contents: chatHistory };
            const response = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(requestBody),
                signal: abortController.signal
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            let answer = uiStrings[currentLanguage].errorFallback;
            if (data.candidates?.[0]?.content?.parts?.[0]) {
                answer = data.candidates[0].content.parts[0].text;
                chatHistory.push({ role: "model", parts: [{ text: answer }] });
            }

            loadingBubble.remove();
            const aiBubble = createAiBubble(answer, false);
            elements.chatMessages.appendChild(aiBubble);
            await typeWriterEffect(aiBubble, answer);
            
            const copyBtn = document.createElement('i');
            copyBtn.classList.add('fas', 'fa-copy', 'copy-btn');
            copyBtn.setAttribute('onclick', 'copyToClipboard(this)');
            aiBubble.appendChild(copyBtn);
            
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;

        } catch (error) {
            console.error('Error:', error);
            if (error.name !== 'AbortError') {
                const errorMessage = uiStrings[currentLanguage].errorAPI;
                const errorBubble = createAiBubble(errorMessage);
                elements.chatMessages.appendChild(errorBubble);
                elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            }
        } finally {
            elements.sendBtn.style.display = 'block';
            elements.stopBtn.style.display = 'none';
            elements.clearBtnContainer.style.display = 'block';
        }
    }

    function createAiBubble(text, useInnerHTML = true) {
        const bubble = document.createElement('div');
        bubble.classList.add('chat-bubble', 'ai-bubble', 'fade-in');
        bubble.setAttribute('data-raw-text', text);
        if (useInnerHTML) {
            bubble.innerHTML = `${marked.parse(text)}<i class="fas fa-copy copy-btn" onclick="copyToClipboard(this)"></i>`;
        }
        return bubble;
    }

    function copyToClipboard(element) {
        const aiBubble = element.closest('.ai-bubble');
        const textToCopy = aiBubble.getAttribute('data-raw-text');
        const formattedText = `${textToCopy}${uiStrings[currentLanguage].copySuffix}`;
        const tempInput = document.createElement('textarea');
        tempInput.value = formattedText;
        document.body.appendChild(tempInput);
        tempInput.select();
        tempInput.setSelectionRange(0, 99999);
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        showCopyFeedback(uiStrings[currentLanguage].copyFeedback);
    }

    function showCopyFeedback(message) {
        const feedbackDiv = document.createElement('div');
        feedbackDiv.innerText = message;
        feedbackDiv.style.cssText = `
            position: fixed;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #444;
            color: #fff;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 200;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        `;
        document.body.appendChild(feedbackDiv);
        setTimeout(() => { feedbackDiv.style.opacity = 1; }, 10);
        setTimeout(() => {
            feedbackDiv.style.opacity = 0;
            setTimeout(() => feedbackDiv.remove(), 500);
        }, 2000);
    }
</script>
</body>
</html>
