<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MirAI</title>
    <meta name="description" content="MirAI is a multimodal AI assistant powered by Google Gemini. Supports text, images, documents, audio, and video.">
    <meta name="keywords" content="Allwaysever, AI, Artificial Intelligence, Chatbot AI, AI Chatbot, Gemini 2.5 flash, Google Gemini, Gemini API, MirAI, Multimodal">
    <meta name="google-site-verification" content="Ww9spnmeAgguaCwvLVAw-0SV0_ZS-bA7bjNgyWKaeQU"/>
    
    <meta property="og:title" content="MirAI - Multimodal AI Assistant" />
    <meta property="og:description" content="MirAI is a multimodal AI assistant powered by Google Gemini. Supports text, images, documents, audio, and video." />
    <meta property="og:url" content="https://allwaysevermirai.netlify.app/" />
    <meta property="og:image" content="https://raw.githubusercontent.com/Allwaysever/MirAI/refs/heads/main/Assets/MirAI%20Banner.png" />
    <meta property="og:type" content="article" />
    <meta property="og:site_name" content="MirAI by Allwaysever" />

    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Allwaysever/MirAI/refs/heads/main/Assets/Favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Allwaysever/MirAI@main/Assets/HTML/MirAIStyle.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        /* Simple image preview */
        .imagePreviewContainer {
            display: none;
            margin-bottom: 10px;
            position: relative;
            max-width: 200px;
        }
        
        .imagePreview {
            max-width: 100%;
            border-radius: 10px;
        }
        
        .imgRemoveBtn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* File bubble styling */
        .file-bubble-preview {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
        }
        
        .dark-theme .file-bubble-preview {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .file-icon {
            font-size: 20px;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: bold;
            font-size: 14px;
            word-break: break-all;
        }
        
        .file-size {
            font-size: 12px;
            color: #666;
        }
        
        .dark-theme .file-size {
            color: #aaa;
        }
    </style>
    
    <script>
        // Auto-generate version based on date
        function generateVersion(major, minor, patch) {
            const now = new Date();
            const yymmdd = now.getFullYear().toString().slice(-2) + 
                           String(now.getMonth() + 1).padStart(2, '0') + 
                           String(now.getDate()).padStart(2, '0');
            
            return `${major}.${minor}.${patch}.${yymmdd}`;
        }

        const VERSION = generateVersion(3, 0, 0);
        
        // File type mapping
        const FILE_ICONS = {
            // Images
            'image/jpeg': 'fa-file-image',
            'image/png': 'fa-file-image',
            'image/webp': 'fa-file-image',
            'image/gif': 'fa-file-image',
            'image/bmp': 'fa-file-image',
            'image/svg+xml': 'fa-file-image',
            'image/heic': 'fa-file-image',
            'image/heif': 'fa-file-image',
            
            // Documents
            'application/pdf': 'fa-file-pdf',
            'application/msword': 'fa-file-word',
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'fa-file-word',
            'application/vnd.ms-excel': 'fa-file-excel',
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'fa-file-excel',
            'application/vnd.ms-powerpoint': 'fa-file-powerpoint',
            'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'fa-file-powerpoint',
            'text/plain': 'fa-file-alt',
            'text/csv': 'fa-file-csv',
            'application/rtf': 'fa-file-alt',
            
            // Audio
            'audio/mpeg': 'fa-file-audio',
            'audio/wav': 'fa-file-audio',
            'audio/ogg': 'fa-file-audio',
            'audio/mp4': 'fa-file-audio',
            'audio/webm': 'fa-file-audio',
            'audio/aac': 'fa-file-audio',
            'audio/flac': 'fa-file-audio',
            
            // Video
            'video/mp4': 'fa-file-video',
            'video/mpeg': 'fa-file-video',
            'video/ogg': 'fa-file-video',
            'video/webm': 'fa-file-video',
            'video/quicktime': 'fa-file-video',
            'video/x-msvideo': 'fa-file-video',
            
            // Archives
            'application/zip': 'fa-file-archive',
            'application/x-rar-compressed': 'fa-file-archive',
            'application/x-7z-compressed': 'fa-file-archive',
            'application/x-tar': 'fa-file-archive',
            'application/gzip': 'fa-file-archive'
        };
        
        const MAX_FILE_SIZE = 25 * 1024 * 1024; // 25MB
    </script>
</head>

<body>

<div id="splash-screen">
  <div class="splash-content">
    <img src="https://raw.githubusercontent.com/Allwaysever/MirAI/refs/heads/main/Assets/Name%20Logo.png" alt="MirAI" class="splash-logo logo-img">
    <div class="loading-bar-container" id="splash-loader">
        <div class="loading-bar"></div>
    </div>
  </div>
 <p style="font-size: 0.5em; color: #aaa; bottom: 5px;"  id="settingsVersionText"></p>
</div>

<div id="settingsBtnContainer">
    <button id="settingsBtn">
        <i class="fas fa-bars"></i>
    </button>
</div>

<div id="clearBtnContainer">
    <button id="clearBtn">
        <i class="fas fa-trash-alt"></i>
    </button>
</div>

<div id="connectionStatus">
    <span id="statusDot" class="status-dot"></span>
    <span id="statusLabel" class="status-label"></span>
</div>

<div class="logo-container">
    <img src="https://raw.githubusercontent.com/Allwaysever/MirAI/refs/heads/main/Assets/HI%20new.png" alt="what are we talking about?" class="hi-img">
</div>

<div id="languageSwitcher">
    <select id="langDropdown" class="lang-dropdown">
        <option value="id">ðŸ‡®ðŸ‡© Bahasa Indonesia</option>
        <option value="en">ðŸ‡ºðŸ‡¸ English (US)</option>
        <option value="en-uk">ðŸ‡¬ðŸ‡§ English (UK)</option>
        <option value="jp">ðŸ‡¯ðŸ‡µ æ—¥æœ¬èªž</option>
    </select>
</div>

<div class="chat-container">
    <div id="chatMessages"></div>
</div>

<div id="toolsMenu" class="suggestion-box"></div>

<div id="inputContainer" class="input-container centered">
    
    <!-- Image Preview Container -->
    <div id="imagePreviewContainer" class="imagePreviewContainer">
       <div class="imagePreviewWrapper">
        <img id="imagePreview" src="" alt="Image Preview" class="imagePreview">
        <button id="removeImageBtn" class="imgRemoveBtn"><i class="fas fa-times"></i></button>
    </div>
</div>
    
    <div id="suggestionBox" class="suggestion-box"></div>
    
    <div class="input-box">
        <button id="toolsBtn">
            <i class="fas fa-plus"></i>
        </button>
        
        <!-- Single Upload Button for all files -->
        <button id="uploadBtn" class="upload-btn" title="Upload File or Image">
            <i class="fas fa-paperclip"></i>
        </button>
        
        <!-- Hidden File Input (accepts all files) -->
        <input type="file" id="fileInput" accept="*/*" style="display: none;">
        
        <textarea id="questionInput" rows="1"></textarea>
        
        <button id="sendBtn">
            <i class="fas fa-paper-plane"></i>
        </button>
        <button id="stopBtn" style="display: none;">
            <i class="fas fa-stop"></i>
        </button>
    </div>
    
    <p id="infoText" class="info-text"></p>
</div>

<!-- Settings Page (with multimodal info) -->
<div id="settingsPage">
    <div class="settings-header">
        <h2 id="settingsHeaderTitle"></h2>
        <button id="backBtn"><i class="fas fa-times"></i></button>
    </div>

    <div class="settings-content">
        <h3 id="settingsAppearanceTitle"></h3>
        <div class="settings-option">
            <p id="settingsThemeText"></p>
            <select id="themeSelect">
                <option value="light" id="themeLightOption"></option>
                <option value="dark" id="themeDarkOption"></option>
            </select>
        </div>
        
        <h3 id="settingsAITitle"></h3>
        <div class="settings-option">
            <p id="settingsPersonaText"></p>
            <select id="personaSelect">
                <option value="formal" id="personaFormalOption"></option>
                <option value="default" id="personaDefaultOption"></option>
                <option value="creative" id="personaCreativeOption"></option>
            </select>
        </div>

        <h3 id="settingsApiTitle"></h3>
        <div class="settings-option">
            <p id="settingsApiText"></p>
            <div class="api-key-container">
                <input type="password" id="apiKeyInput">
                <i class="fas fa-eye" id="toggleApiKey"></i>
            </div>
            <button id="saveApiBtn" class="settings-credits-btn"></button>
        </div>
        
        <h3 id="settingsAboutTitle"></h3>
        <div class="settings-about">
            <p id="settingsAuthorText"></p>
            <p><a href="https://allwaysevermirai.netlify.app/about" target="_blank" id="githubLink"><i class="fas fa-info-circle"></i></a></p>
            <p><a href="https://github.com/Allwaysever/MirAI/blob/main/LICENSE" id="licenseLink" target="_blank"></a></p>
            <p><a href="help/index.html" id="helpLink" target="_self"></a></p>
            
            <!-- Multimodal info -->
            <div class="settings-option" style="margin-top: 20px;">
                <p style="font-weight: bold; color: #4285f4;">
                    <i class="fas fa-file-upload"></i> Multimodal Features
                </p>
                <p style="font-size: 0.9em; color: #666; line-height: 1.5;">
                    Upload and analyze:<br>
                    â€¢ Images (JPEG, PNG, WebP, HEIC)<br>
                    â€¢ PDF Documents<br>
                    â€¢ Word, Excel, PowerPoint<br>
                    â€¢ Text Files<br>
                    â€¢ Audio Files (MP3, WAV, etc.)<br>
                    â€¢ Video Files (MP4, WebM, etc.)
                </p>
                <p style="font-size: 0.8em; color: #888; margin-top: 8px;">
                    <i class="fas fa-info-circle"></i> Max file size: 25MB
                </p>
            </div>
            
            <div class="gemini-container">
               <a href="https://deepmind.google/models/gemini/flash/" target="_blank"><img src="https://raw.githubusercontent.com/Allwaysever/MirAI/refs/heads/main/Assets/Gemini%202.5%20Flash%20Logo.png" alt="Google Gemini 2.5 Flash" class="gemini-logo"></a>
            </div>
            
            <p id="termsText"></p>
        </div>
    </div>
</div>

<div id="customConfirmOverlay">
    <div id="customConfirmBox">
        <p id="customConfirmMessage"></p>
        <div class="custom-confirm-buttons">
            <button id="confirmBtnYes"></button>
            <button id="confirmBtnNo"></button>
        </div>
    </div>
</div>

<script>
    const DEFAULT_API_KEY = 'AIzaSyBclOlr7UNm1Leoj83fB9uJR7Jt6qQRphA';
    let currentApiKey = DEFAULT_API_KEY; 
    const model = 'gemini-2.5-flash';
    
    // Gemini supported types (officially supported)
    const GEMINI_SUPPORTED_TYPES = [
        'image/jpeg', 'image/png', 'image/webp', 'image/heic', 'image/heif',
        'application/pdf',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'application/vnd.openxmlformats-officedocument.presentationml.presentation',
        'text/plain'
    ];
    
    const faqDatabase = {
        "changelog": "# Changelog\n\n Check this project's [github repository](https://github.com/Allwaysever/MirAI/blob/main/CHANGELOG.md) for changelogs information.",
        "donate": "# Donate\n\n Please donate to add features and improve AI capabilities. [Buy us a DiamondStars](https://trakteer.id/Allwaysever)",
        "multimodal": "# Multimodal Features\n\nUpload files and ask questions about them:\n\nâ€¢ **Images** - Describe, analyze, extract text\nâ€¢ **PDFs** - Summarize, answer questions\nâ€¢ **Documents** - Read Word, Excel, PowerPoint\nâ€¢ **Audio** - Transcribe, analyze content\nâ€¢ **Video** - Extract information\n\nSimply upload and ask!"
    };

    const uiStrings = {
        'id': {
            // Existing strings...
            offlineTitle: 'Koneksi Internet Terputus',
            offlineText: 'Silakan periksa koneksi WiFi atau data seluler Anda, lalu coba kembali.',
            retryButton: 'Coba Lagi',
            inputPlaceholder: 'Ketik pertanyaan Anda di sini...',
            copyFeedback: 'Teks berhasil disalin!',
            langSwitchFeedback: 'Bahasa telah diubah ke',
            errorAPI: 'Terjadi kesalahan. Silakan muat ulang atau coba beberapa saat lagi.',
            errorFallback: 'Maaf, jawaban tidak ditemukan. Coba gunakan kata kunci yang berbeda.',
            errorConnection: 'Koneksi internet tidak tersedia. Mohon periksa kembali.',
            checkingConnection: 'Memeriksa koneksi internet...',
            copySuffix: '\n\n-- Dihasilkan oleh MirAI',
            infoText: 'Informasi yang dihasilkan AI mungkin tidak akurat. Verifikasi kembali fakta penting.',
            settingsHeaderTitle: 'Pengaturan',
            settingsAppearanceTitle: 'Tampilan',
            settingsThemeText: 'Pilih preferensi tema Anda:',
            themeLightOption: 'Terang',
            themeDarkOption: 'Gelap',
            settingsAITitle: 'Persona AI',
            settingsPersonaText: 'Pilih gaya respons AI:',
            personaFormalOption: 'Formal & Profesional',
            personaDefaultOption: 'Santai & Bercanda',
            personaCreativeOption: 'Kreatif & Ekspresif',
            settingsAboutTitle: 'Tentang Aplikasi',
            settingsVersionText: `Versi: v${VERSION}`,
            settingsAuthorText: 'Dikembangkan oleh Allwaysever',
            githubLink: 'Tentang MirAI',
            licenseLink: 'Lisensi',
            helpLink: 'Pusat Bantuan',
            termsText: 'Dengan menggunakan MirAI, Anda menyetujui <a href="T&C/index.html" target="_blank">Syarat & Ketentuan</a>.',
            personaDefaultPrompt: 'Anda adalah MirAI, asisten AI yang santai dan suka bercanda. Jawab semua pertanyaan dengan gaya yang ramah, sedikit humor, namun tetap informatif.',
            personaFormalPrompt: 'Anda adalah MirAI, asisten AI profesional. Berikan jawaban yang terstruktur, akurat, dan menggunakan bahasa formal.',
            personaCreativePrompt: 'Anda adalah MirAI, asisten AI yang kreatif. Berikan jawaban yang unik, imajinatif, dan ekspresif untuk setiap pertanyaan.',
            placeholderMessages: ['Ajukan pertanyaan apa pun.', 'Butuh bantuan untuk ide?', 'Minta terjemahan atau ringkasan.', 'Bagaimana saya bisa membantu?'],
            onlineStatus: 'Terhubung',
            offlineStatus: 'Terputus',
            settingsApiTitle: 'Kunci API Google',
            settingsApiText: 'Masukkan Kunci API kustom Anda:',
            apiKeySaved: 'Kunci API berhasil disimpan.',
            apiKeyRemoved: 'Kunci API dihapus. Menggunakan kunci default.',
            dateTimeContextPrompt: '[{dateTime}]:',
            confirmClearMessage: 'Apakah Anda yakin ingin menghapus riwayat percakapan ini? Tindakan ini tidak dapat diurungkan.',
            confirmClearYes: 'Ya, Hapus',
            confirmClearNo: 'Batal',
            pageTitle: 'MirAI | Asisten Multimodal AI Anda',
            saveApiKeyBtn: 'Simpan',
            apiKeyPlaceholder: 'Kosongkan untuk menggunakan kunci default',
            
            // New multimodal strings
            fileTooLarge: 'Ukuran file terlalu besar. Maksimal 25MB.',
            unsupportedFileType: 'Tipe file tidak didukung.',
            uploadingFile: 'Mengupload file...',
            uploadComplete: 'Upload selesai',
            uploadFailed: 'Upload gagal',
            fileUploaded: 'File berhasil diupload'
        },
        'en': {
            // Existing strings...
            offlineTitle: 'Internet Connection Lost',
            offlineText: 'Please check your WiFi or cellular data connection, then try again.',
            retryButton: 'Retry',
            inputPlaceholder: 'Type your question here...',
            copyFeedback: 'Text copied to clipboard!',
            langSwitchFeedback: 'Language has been changed to',
            errorAPI: 'An error occurred. Please reload the page or try again shortly.',
            errorFallback: 'Sorry, no answer was found. Please try different keywords.',
            errorConnection: 'Internet connection is unavailable. Please check and try again.',
            checkingConnection: 'Checking internet connection...',
            copySuffix: '\n\n-- Generated by MirAI',
            infoText: 'AI-generated information may be inaccurate. Please verify important facts.',
            settingsHeaderTitle: 'Settings',
            settingsAppearanceTitle: 'Appearance',
            settingsThemeText: 'Select your theme preference:',
            themeLightOption: 'Light',
            themeDarkOption: 'Dark',
            settingsAITitle: 'AI Persona',
            settingsPersonaText: 'Choose the AI\'s response style:',
            personaFormalOption: 'Formal & Professional',
            personaDefaultOption: 'Chill & joking',
            personaCreativeOption: 'Creative & Expressive',
            settingsAboutTitle: 'About',
            settingsVersionText: `Version: v${VERSION}`,
            settingsAuthorText: 'Developed by Allwaysever',
            githubLink: 'About MirAI',
            licenseLink: 'License',
            helpLink: 'Help Center',
            termsText: 'By using MirAI, you agree to the <a href="T&C/index.html" target="_blank">Terms & Conditions</a>.',
            personaDefaultPrompt: 'You are MirAI, a relaxed and humorous AI assistant. Answer all questions in a friendly style, with a bit of humor, while remaining informative.',
            personaFormalPrompt: 'You are MirAI, a professional AI assistant. Provide well-structured, accurate, and formal responses.',
            personaCreativePrompt: 'You are MirAI, a creative AI assistant. Provide unique, imaginative, and expressive answers to every query.',
            placeholderMessages: ['Ask any question.', 'Need help with an idea?', 'Request a translation or summary.', 'How can I assist you?'],
            onlineStatus: 'Connected',
            offlineStatus: 'Disconnected',
            settingsApiTitle: 'Google API Key',
            settingsApiText: 'Enter your custom API Key:',
            apiKeySaved: 'API Key saved successfully.',
            apiKeyRemoved: 'API Key removed. Using default key.',
            dateTimeContextPrompt: '[{dateTime}]:',
            confirmClearMessage: 'Are you sure you want to delete this chat history? This action cannot be undone.',
            confirmClearYes: 'Yes, Delete',
            confirmClearNo: 'Cancel',
            pageTitle: 'MirAI | Your Multimodal AI Assistant',
            saveApiKeyBtn: 'Save',
            apiKeyPlaceholder: 'Leave blank to use the default key',
            
            // New multimodal strings
            fileTooLarge: 'File is too large. Maximum 25MB.',
            unsupportedFileType: 'File type not supported.',
            uploadingFile: 'Uploading file...',
            uploadComplete: 'Upload complete',
            uploadFailed: 'Upload failed',
            fileUploaded: 'File uploaded successfully'
        },
        'en-uk': {
            // Similar to 'en'...
            fileTooLarge: 'File is too large. Maximum 25MB.',
            unsupportedFileType: 'File type not supported.',
            uploadingFile: 'Uploading file...',
            uploadComplete: 'Upload complete',
            uploadFailed: 'Upload failed',
            fileUploaded: 'File uploaded successfully'
        },
        'jp': {
            // Similar to 'jp'...
            fileTooLarge: 'ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã™ãŽã¾ã™ã€‚æœ€å¤§25MBã§ã™ã€‚',
            unsupportedFileType: 'ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã§ã™ã€‚',
            uploadingFile: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...',
            uploadComplete: 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†',
            uploadFailed: 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—',
            fileUploaded: 'ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ'
        }
    };

    let slashCommands = [];
    let chatHistory = [];
    let abortController = null;
    let currentLanguage = 'en';
    let currentPersona = 'default';
    let currentFileData = null; // Stores file data (can be image or other file)
    let elements;

    // Helper functions
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function getFileIcon(mimeType) {
        return FILE_ICONS[mimeType] || 'fa-file';
    }
    
    function isSupportedByGemini(mimeType) {
        return GEMINI_SUPPORTED_TYPES.includes(mimeType);
    }
    
    // Convert file to base64
    function convertFileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => {
                const base64String = reader.result.split(',')[1];
                resolve({
                    mimeType: file.type,
                    data: base64String,
                    name: file.name,
                    size: file.size,
                    isImage: file.type.startsWith('image/')
                });
            };
            reader.onerror = error => reject(error);
        });
    }
    
    // Handle file upload
    async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Basic validation
        if (file.size > MAX_FILE_SIZE) {
            alert(uiStrings[currentLanguage].fileTooLarge);
            return;
        }
        
        // Check if supported by Gemini (but we'll try anyway for other types)
        if (!isSupportedByGemini(file.type)) {
            if (!confirm("File type might not be fully supported by Gemini. Try anyway?")) {
                return;
            }
        }
        
        // Reset input
        elements.fileInput.value = '';
        
        try {
            const fileData = await convertFileToBase64(file);
            currentFileData = fileData;
            
            // If it's an image, show preview
            if (fileData.isImage) {
                elements.imagePreview.src = `data:${file.type};base64,${fileData.data}`;
                elements.imagePreviewContainer.style.display = 'flex';
            }
            
            // Auto-focus to text input and suggest question
            elements.questionInput.focus();
            updateSendButtonState();
            
            // Auto-suggest based on file type
            autoSuggestQuestion(file.type);
            
        } catch (error) {
            console.error('Error processing file:', error);
            alert('Error processing file');
            removeFile();
        }
    }
    
    function autoSuggestQuestion(mimeType) {
        const suggestions = {
            'image': 'Describe this image',
            'application/pdf': 'Summarize this PDF',
            'application/vnd.openxmlformats-officedocument': 'What is in this document?',
            'text': 'What does this text say?',
            'audio': 'Transcribe this audio',
            'video': 'Describe this video'
        };
        
        let suggestion = 'What can you tell me about this file?';
        
        if (mimeType.startsWith('image/')) {
            suggestion = suggestions.image;
        } else if (mimeType === 'application/pdf') {
            suggestion = suggestions.pdf;
        } else if (mimeType.includes('openxmlformats')) {
            suggestion = suggestions.document;
        } else if (mimeType.startsWith('text/')) {
            suggestion = suggestions.text;
        } else if (mimeType.startsWith('audio/')) {
            suggestion = suggestions.audio;
        } else if (mimeType.startsWith('video/')) {
            suggestion = suggestions.video;
        }
        
        elements.questionInput.value = suggestion;
    }
    
    function removeFile() {
        currentFileData = null;
        elements.imagePreview.src = '';
        elements.imagePreviewContainer.style.display = 'none';
        updateSendButtonState();
    }
    
    // Modified askAI function for multimodal
    async function askAI() {
        const userQuestion = elements.questionInput.value;

        // Don't send if no text AND no file
        if (userQuestion.trim() === '' && !currentFileData) return;

        const clientDateTime = getCurrentDateTimeString();
        const promptTemplate = uiStrings[currentLanguage].dateTimeContextPrompt;
        const contextPrompt = promptTemplate.replace('{dateTime}', clientDateTime);
        
        let promptToSendToAI;

        // Process slash command only if no file
        if (!currentFileData) {
            const processedPrompt = handleSlashCommand(userQuestion);
            if (processedPrompt !== null) {
                if (processedPrompt.startsWith('Error:')) {
                    return;
                }
                promptToSendToAI = `${contextPrompt}\n\n"${processedPrompt}"`;
            } else {
                promptToSendToAI = `${contextPrompt}\n\n"${userQuestion}"`;
            }
        } else {
            // If there's a file, send text as is
            promptToSendToAI = `${contextPrompt}\n\n"${userQuestion}"`;
        }

        toggleChatUI(true);
        elements.questionInput.value = '';
        elements.questionInput.style.height = 'auto';
        elements.suggestionBox.classList.remove('visible');
        updateSendButtonState();
        elements.sendBtn.style.display = 'none';
        elements.clearBtnContainer.style.display = 'none';
        elements.stopBtn.style.display = 'block';

        // Create user bubble
        const userBubble = document.createElement('div');
        userBubble.classList.add('chat-bubble', 'user-bubble');
        
        let bubbleContent = '';
        
        // Add file preview to bubble
        if (currentFileData) {
            if (currentFileData.isImage) {
                // Show image
                bubbleContent += `<img src="${elements.imagePreview.src}" style="width: 100%; max-width: 200px; border-radius: 10px; margin-bottom: 5px;"><br>`;
            } else {
                // Show file info
                const iconClass = getFileIcon(currentFileData.mimeType);
                bubbleContent += `
                    <div class="file-bubble-preview">
                        <i class="fas ${iconClass} file-icon"></i>
                        <div class="file-info">
                            <div class="file-name">${currentFileData.name}</div>
                            <div class="file-size">${formatFileSize(currentFileData.size)}</div>
                        </div>
                    </div>`;
            }
        }
        
        // Add text if exists
        if (userQuestion.trim() !== '') {
            if (bubbleContent) bubbleContent += '<br>';
            bubbleContent += userQuestion;
        }
        
        userBubble.innerHTML = bubbleContent;
        
        elements.chatMessages.appendChild(userBubble);
        setTimeout(() => userBubble.classList.add('fade-in'), 10);
        elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;

        // Construct parts for API request
        const userParts = [];
        
        // 1. Add text part
        userParts.push({ text: promptToSendToAI });

        // 2. Add file part if exists
        if (currentFileData) {
            userParts.push({
                inlineData: {
                    mimeType: currentFileData.mimeType,
                    data: currentFileData.data
                }
            });
        }
        
        // Push to chatHistory
        chatHistory.push({ role: "user", parts: userParts }); 
        saveChatHistory(); 
        
        // Clear file data for next message
        removeFile();

        const loadingBubble = showLoading();

        // Skip local answers if there's a file
        if (!currentFileData) {
            const localAnswer = findSmartAnswer(userQuestion);
            if (localAnswer) {
                loadingBubble.remove();
                const aiBubble = createAiBubble(localAnswer, true);
                elements.chatMessages.appendChild(aiBubble);
                elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
                elements.sendBtn.style.display = 'block';
                elements.stopBtn.style.display = 'none';
                elements.clearBtnContainer.style.display = 'block';
                return; 
            }
        }

        try {
            abortController = new AbortController();
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${currentApiKey}`;
            
            const requestBody = { contents: chatHistory };
            
            const response = await fetch(url, { 
                method: "POST", 
                headers: { "Content-Type": "application/json" }, 
                body: JSON.stringify(requestBody), 
                signal: abortController.signal 
            });
            
            if (!response.ok) { 
                throw new Error(`HTTP error! status: ${response.status}`); 
            }
            
            const data = await response.json();
            let answer = uiStrings[currentLanguage].errorFallback;
            
            if (data.candidates?.[0]?.content?.parts?.[0]) {
                answer = data.candidates[0].content.parts[0].text;
                chatHistory.push({ role: "model", parts: [{ text: answer }] });
                saveChatHistory(); 
            }
            
            loadingBubble.remove();
            const aiBubble = createAiBubble(answer, false);
            elements.chatMessages.appendChild(aiBubble);
            await typeWriterEffect(aiBubble, answer);
            
            // Add copy and speak buttons
            const copyBtn = document.createElement('i');
            copyBtn.classList.add('fas', 'fa-copy', 'copy-btn');
            copyBtn.setAttribute('onclick', 'copyToClipboard(this)');
            aiBubble.appendChild(copyBtn);

            const speakBtn = document.createElement('i');
            speakBtn.classList.add('fas', 'fa-volume-up', 'speak-btn');
            speakBtn.setAttribute('onclick', 'speakText(this)');
            aiBubble.appendChild(speakBtn);

            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            
        } catch (error) {
            console.error('Error:', error);
            if (error.name !== 'AbortError') {
                const errorMessage = navigator.onLine ? uiStrings[currentLanguage].errorAPI : uiStrings[currentLanguage].errorConnection;
                loadingBubble.remove();
                const errorBubble = createAiBubble(errorMessage);
                elements.chatMessages.appendChild(errorBubble);
                elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            }
        } finally {
            elements.sendBtn.style.display = 'block';
            elements.stopBtn.style.display = 'none';
            elements.clearBtnContainer.style.display = 'block';
        }
    }

    // Modified updateSendButtonState
    function updateSendButtonState() { 
        if (elements.questionInput.value.trim() === '' && !currentFileData) { 
            elements.sendBtn.classList.add('disabled'); 
            elements.sendBtn.disabled = true; 
        } else { 
            elements.sendBtn.classList.remove('disabled'); 
            elements.sendBtn.disabled = false; 
        } 
    }

    // Modified clearChat
    function clearChat() {
        elements.chatMessages.innerHTML = '';
        localStorage.removeItem('miraiChatHistory'); 
        initializeNewChatSession(); 
        toggleChatUI(false);
        updateDynamicPlaceholder();
        
        // Clear uploaded file
        removeFile();
        
        // Stop TTS if playing
        if (window.speechSynthesis.speaking) {
            window.speechSynthesis.cancel();
        }
    }

    // === SEMUA FUNGSI LAINNYA TETAP SAMA ===
    // [Tempatkan semua fungsi yang tidak dimodifikasi di sini]
    // initializeSlashCommands, convertImageToBase64, initializeNewChatSession, loadChatHistory, saveChatHistory, showClearConfirmation, hideClearConfirmation, setPersona, setLanguage, getCurrentDateTimeString, populateToolsMenu, saveApiKey, toggleApiVisibility, updateConnectionStatus, updateDynamicPlaceholder, updateSettingsUI, setTheme, showSettingsPage, hideSettingsPage, simulateLoading, showSuggestions, findSmartAnswer, typeWriterEffect, showLoading, stopAI, handleSlashCommand, createAiBubble, getLangCodeForSpeech, speakText, copyToClipboard, showCopyFeedback, checkIndicatorPosition
    
    // Initialize app
    function initializeApp() {
        const savedLang = localStorage.getItem('miraiLanguage');
        if (savedLang && uiStrings.hasOwnProperty(savedLang)) {
            currentLanguage = savedLang;
        } else {
            currentLanguage = 'id';
        }

        currentPersona = localStorage.getItem('miraiPersona') || 'default';
        const savedTheme = localStorage.getItem('miraiTheme') || 'dark';
        const savedApiKey = localStorage.getItem('miraiApiKey');
        
        elements.langDropdown.value = currentLanguage;
        elements.personaSelect.value = currentPersona;
        
        if (savedApiKey) {
            currentApiKey = savedApiKey;
            elements.apiKeyInput.value = savedApiKey;
        }
        
        initializeSlashCommands(currentLanguage);
        setTheme(savedTheme);
        updateUI();
        
        const historyLoaded = loadChatHistory();
        if (!historyLoaded) {
            initializeNewChatSession();
        }
    }

    // DOM ready
    document.addEventListener('DOMContentLoaded', () => {
        elements = { 
            questionInput: document.getElementById('questionInput'),
            sendBtn: document.getElementById('sendBtn'),
            stopBtn: document.getElementById('stopBtn'),
            clearBtn: document.getElementById('clearBtn'),
            clearBtnContainer: document.getElementById('clearBtnContainer'),
            settingsBtn: document.getElementById('settingsBtn'),
            chatMessages: document.getElementById('chatMessages'),
            suggestionBox: document.getElementById('suggestionBox'),
            body: document.body,
            inputContainer: document.getElementById('inputContainer'),
            logoContainer: document.querySelector('.logo-container'),
            splashScreen: document.getElementById('splash-screen'),
            langDropdown: document.getElementById('langDropdown'),
            languageSwitcher: document.getElementById('languageSwitcher'),
            infoText: document.getElementById('infoText'),
            settingsPage: document.getElementById('settingsPage'),
            backBtn: document.getElementById('backBtn'),
            themeSelect: document.getElementById('themeSelect'),
            personaSelect: document.getElementById('personaSelect'),
            settingsHeaderTitle: document.getElementById('settingsHeaderTitle'),
            settingsAppearanceTitle: document.getElementById('settingsAppearanceTitle'),
            settingsThemeText: document.getElementById('settingsThemeText'),
            themeLightOption: document.getElementById('themeLightOption'),
            themeDarkOption: document.getElementById('themeDarkOption'),
            settingsAITitle: document.getElementById('settingsAITitle'),
            settingsPersonaText: document.getElementById('settingsPersonaText'),
            personaFormalOption: document.getElementById('personaFormalOption'),
            personaDefaultOption: document.getElementById('personaDefaultOption'),
            personaCreativeOption: document.getElementById('personaCreativeOption'),
            settingsAboutTitle: document.getElementById('settingsAboutTitle'),
            settingsVersionText: document.getElementById('settingsVersionText'),
            settingsAuthorText: document.getElementById('settingsAuthorText'),
            githubLink: document.getElementById('githubLink'),
            licenseLink: document.getElementById('licenseLink'),
            statusDot: document.getElementById('statusDot'),
            statusLabel: document.getElementById('statusLabel'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            toggleApiKey: document.getElementById('toggleApiKey'),
            saveApiBtn: document.getElementById('saveApiBtn'),
            settingsApiTitle: document.getElementById('settingsApiTitle'),
            settingsApiText: document.getElementById('settingsApiText'),
            toolsBtn: document.getElementById('toolsBtn'),
            toolsMenu: document.getElementById('toolsMenu'),
            customConfirmOverlay: document.getElementById('customConfirmOverlay'),
            customConfirmMessage: document.getElementById('customConfirmMessage'),
            confirmBtnYes: document.getElementById('confirmBtnYes'),
            confirmBtnNo: document.getElementById('confirmBtnNo'),
            helpLink: document.getElementById('helpLink'),
            termsText: document.getElementById('termsText'),
            
            // File elements
            uploadBtn: document.getElementById('uploadBtn'),
            fileInput: document.getElementById('fileInput'),
            imagePreviewContainer: document.getElementById('imagePreviewContainer'),
            imagePreview: document.getElementById('imagePreview'),
            removeImageBtn: document.getElementById('removeImageBtn')
        };

        // Event listeners
        elements.sendBtn.addEventListener('click', askAI);
        elements.stopBtn.addEventListener('click', stopAI);
        elements.clearBtn.addEventListener('click', showClearConfirmation);
        elements.settingsBtn.addEventListener('click', showSettingsPage);
        elements.backBtn.addEventListener('click', hideSettingsPage);
        elements.themeSelect.addEventListener('change', (e) => setTheme(e.target.value));
        elements.personaSelect.addEventListener('change', (e) => setPersona(e.target.value, true));
        elements.langDropdown.addEventListener('change', (event) => setLanguage(event.target.value, true));
        
        elements.questionInput.addEventListener('keydown', (event) => { 
            if (event.key === 'Enter' && !event.shiftKey) { 
                event.preventDefault(); 
                if (!elements.sendBtn.disabled) { 
                    askAI(); 
                } 
            } 
        });
        
        elements.questionInput.addEventListener('input', () => { 
            showSuggestions(); 
            updateSendButtonState(); 
            elements.questionInput.style.height = 'auto'; 
            elements.questionInput.style.height = elements.questionInput.scrollHeight + 'px'; 
        });
        
        elements.saveApiBtn.addEventListener('click', saveApiKey);
        elements.toggleApiKey.addEventListener('click', toggleApiVisibility);
        
        // File upload
        elements.uploadBtn.addEventListener('click', () => elements.fileInput.click());
        elements.fileInput.addEventListener('change', handleFileUpload);
        elements.removeImageBtn.addEventListener('click', removeFile);
        
        // Other event listeners
        elements.confirmBtnYes.addEventListener('click', () => { 
            clearChat(); 
            hideClearConfirmation();
        });
        
        elements.confirmBtnNo.addEventListener('click', hideClearConfirmation);
        
        elements.toolsBtn.addEventListener('click', (event) => { 
            event.stopPropagation(); 
            const isActive = elements.toolsBtn.classList.contains('active'); 
            elements.suggestionBox.classList.remove('visible'); 
            if (!isActive) { 
                elements.toolsMenu.classList.add('visible'); 
                elements.toolsBtn.classList.add('active'); 
            } else { 
                elements.toolsMenu.classList.remove('visible'); 
                elements.toolsBtn.classList.remove('active'); 
            } 
        });
        
        document.addEventListener('click', (event) => { 
            if (elements.toolsMenu && !elements.toolsMenu.contains(event.target) && !elements.toolsBtn.contains(event.target)) { 
                elements.toolsMenu.classList.remove('visible'); 
                elements.toolsBtn.classList.remove('active'); 
            } 
        });
        
        window.addEventListener('scroll', checkIndicatorPosition, { passive: true });
        
        // Initialize app
        initializeApp();
        simulateLoading(3000); 
        updateConnectionStatus();
        populateToolsMenu();
        updateSendButtonState();
        
        // Stop TTS on page unload
        window.addEventListener('beforeunload', () => {
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
        });
    });

    // ========== FUNGSI-FUNGSI ORIGINAL YANG TIDAK DIMODIFIKASI ==========

function initializeSlashCommands(lang) {
    const s = uiStrings[lang];
    slashCommands = [
        { command: '/search', title: s.slashCmdSearchTitle, description: '/search [search query]' },
        { command: '/translate', title: s.slashCmdTranslateTitle, description: '/translate [text] to [language]' },
        { command: '/summarize', title: s.slashCmdSummarizeTitle, description: '/summarize [long text]' },
        { command: '/rephrase', title: s.slashCmdRephraseTitle, description: '/rephrase [text] as [tone]' },
        { command: '/ideate', title: s.slashCmdIdeateTitle, description: '/ideate [amount] ideas for [topic]' },
        { command: '/fix', title: s.slashCmdFixTitle, description: '/fix [text that needs to be corrected]' },
        { command: '/explain', title: s.slashCmdExplainTitle, description: '/explain [concept] like I\'m [audience]' },
        { command: '/code', title: s.slashCmdCodeTitle, description: '/code a [programming language] function to [description]' }
    ];
}

function initializeNewChatSession() {
    const personaPromptText = uiStrings[currentLanguage][`persona${currentPersona.charAt(0).toUpperCase() + currentPersona.slice(1)}Prompt`];
    chatHistory = [{ role: "user", parts: [{ text: personaPromptText }] }];
    console.log('Sesi chat baru dimulai.');
}

function loadChatHistory() {
    const savedHistory = localStorage.getItem('miraiChatHistory');
    if (savedHistory) {
        chatHistory = JSON.parse(savedHistory);
        console.log('Riwayat percakapan berhasil dimuat.', chatHistory);
        return true; 
    }
    console.log('Tidak ada riwayat untuk dimuat.');
    return false; 
}

function saveChatHistory() {
    const maxHistoryLength = 50; 
    if (chatHistory.length > maxHistoryLength) {
        const personaPrompt = chatHistory[0];
        const conversation = chatHistory.slice(chatHistory.length - maxHistoryLength + 1);
        chatHistory = [personaPrompt, ...conversation];
    }
    localStorage.setItem('miraiChatHistory', JSON.stringify(chatHistory));
}

function showClearConfirmation() {
    const lang = uiStrings[currentLanguage];
    elements.customConfirmMessage.innerText = lang.confirmClearMessage;
    elements.confirmBtnYes.innerText = lang.confirmClearYes;
    elements.confirmBtnNo.innerText = lang.confirmClearNo;
    elements.customConfirmOverlay.classList.add('visible');
}

function hideClearConfirmation() {
    elements.customConfirmOverlay.classList.remove('visible');
}

function setPersona(persona, fromUserInteraction = false) {
    currentPersona = persona;
    elements.personaSelect.value = persona;
    localStorage.setItem('miraiPersona', persona);
    if (fromUserInteraction) {
        // clearChat(); // Diberi komentar agar tidak dijalankan sesuai permintaan
    }
}

function setLanguage(lang, fromUserInteraction = false) {
    currentLanguage = lang;
    elements.langDropdown.value = lang;
    localStorage.setItem('miraiLanguage', lang);
    initializeSlashCommands(currentLanguage);
    populateToolsMenu();
    updateUI();
    if (fromUserInteraction) {
        // clearChat(); // Diberi komentar agar tidak dijalankan sesuai permintaan
    }
}

function getCurrentDateTimeString() { 
    const now = new Date(); 
    const year = now.getFullYear(); 
    const month = String(now.getMonth() + 1).padStart(2, '0'); 
    const day = String(now.getDate()).padStart(2, '0'); 
    const hours = String(now.getHours()).padStart(2, '0'); 
    const minutes = String(now.getMinutes()).padStart(2, '0'); 
    const seconds = String(now.getSeconds()).padStart(2, '0'); 
    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`; 
}

function populateToolsMenu() { 
    if (!elements.toolsMenu) return; 
    elements.toolsMenu.innerHTML = ''; 
    slashCommands.forEach(cmd => { 
        const menuItem = document.createElement('div'); 
        menuItem.classList.add('suggestion-item-slash'); 
        menuItem.innerHTML = `<strong>${cmd.command}</strong><span>${cmd.description}</span>`; 
        menuItem.addEventListener('click', () => { 
            elements.questionInput.value = cmd.command + ' '; 
            elements.toolsMenu.classList.remove('visible'); 
            elements.toolsBtn.classList.remove('active'); 
            elements.questionInput.focus(); 
        }); 
        elements.toolsMenu.appendChild(menuItem); 
    }); 
}

function saveApiKey() { 
    const newKey = elements.apiKeyInput.value.trim(); 
    if (newKey) { 
        localStorage.setItem('miraiApiKey', newKey); 
        currentApiKey = newKey; 
        showCopyFeedback(uiStrings[currentLanguage].apiKeySaved); 
    } else { 
        localStorage.removeItem('miraiApiKey'); 
        currentApiKey = DEFAULT_API_KEY; 
        showCopyFeedback(uiStrings[currentLanguage].apiKeyRemoved); 
    } 
}

function toggleApiVisibility() { 
    const input = elements.apiKeyInput; 
    const icon = elements.toggleApiKey; 
    if (input.type === 'password') { 
        input.type = 'text'; 
        icon.classList.remove('fa-eye'); 
        icon.classList.add('fa-eye-slash'); 
    } else { 
        input.type = 'password'; 
        icon.classList.remove('fa-eye-slash'); 
        icon.classList.add('fa-eye'); 
    } 
}

function updateConnectionStatus() { 
    if (navigator.onLine) { 
        elements.statusDot.classList.remove('offline'); 
        elements.statusDot.classList.add('online'); 
        elements.statusLabel.innerText = uiStrings[currentLanguage].onlineStatus; 
    } else { 
        elements.statusDot.classList.remove('online'); 
        elements.statusDot.classList.add('offline'); 
        elements.statusLabel.innerText = uiStrings[currentLanguage].offlineStatus; 
    } 
}

function updateUI() {
    const lang = uiStrings[currentLanguage];
    elements.infoText.innerText = lang.infoText;
    updateSettingsUI();
    updateDynamicPlaceholder();
    updateConnectionStatus();
}

function updateDynamicPlaceholder() { 
    const placeholders = uiStrings[currentLanguage].placeholderMessages; 
    const randomIndex = Math.floor(Math.random() * placeholders.length); 
    elements.questionInput.placeholder = placeholders[randomIndex]; 
}

function updateSettingsUI() { 
    const lang = uiStrings[currentLanguage]; 
    if (!lang) return; 
    elements.settingsHeaderTitle.innerText = lang.settingsHeaderTitle; 
    elements.settingsAppearanceTitle.innerText = lang.settingsAppearanceTitle; 
    elements.settingsThemeText.innerText = lang.settingsThemeText; 
    elements.themeLightOption.innerText = lang.themeLightOption; 
    elements.themeDarkOption.innerText = lang.themeDarkOption; 
    elements.settingsAITitle.innerText = lang.settingsAITitle; 
    elements.settingsPersonaText.innerText = lang.settingsPersonaText; 
    elements.personaFormalOption.innerText = lang.personaFormalOption; 
    elements.personaDefaultOption.innerText = lang.personaDefaultOption; 
    elements.personaCreativeOption.innerText = lang.personaCreativeOption; 
    elements.settingsAboutTitle.innerText = lang.settingsAboutTitle; 
    elements.settingsVersionText.innerText = lang.settingsVersionText; 
    elements.settingsAuthorText.innerText = lang.settingsAuthorText; 
    elements.githubLink.innerText = lang.githubLink; 
    elements.licenseLink.innerText = lang.licenseLink; 
    elements.helpLink.innerText = lang.helpLink; 
    elements.termsText.innerHTML = lang.termsText; 
    elements.settingsApiTitle.innerText = lang.settingsApiTitle; 
    elements.settingsApiText.innerText = lang.settingsApiText; 
    document.title = lang.pageTitle; 
    elements.saveApiBtn.innerText = lang.saveApiKeyBtn; 
    elements.apiKeyInput.placeholder = lang.apiKeyPlaceholder; 
}

function setTheme(theme) { 
    elements.body.classList.remove('light-theme', 'dark-theme'); 
    if (theme === 'light') { 
        elements.body.classList.add('light-theme'); 
    } else { 
        elements.body.classList.add('dark-theme'); 
    } 
    localStorage.setItem('miraiTheme', theme); 
    elements.themeSelect.value = theme; 
}

function showSettingsPage() { 
    elements.settingsPage.classList.add('active'); 
    elements.body.classList.remove('chat-active'); 
}

function hideSettingsPage() { 
    elements.settingsPage.classList.remove('active'); 
    if (chatHistory.length > 1) { 
        elements.body.classList.add('chat-active'); 
    } 
}

function toggleChatUI(active) {
    if (active) {
        elements.body.classList.add('chat-active');
        elements.inputContainer.classList.remove('centered');
        elements.inputContainer.classList.add('bottom');
        elements.logoContainer.classList.add('logo-hidden');
        elements.languageSwitcher.classList.add('lang-hidden');
        elements.infoText.style.display = 'block';
    } else {
        elements.body.classList.remove('chat-active');
        elements.inputContainer.classList.remove('bottom');
        elements.inputContainer.classList.add('centered');
        elements.logoContainer.classList.remove('logo-hidden');
        elements.languageSwitcher.classList.remove('lang-hidden');
        elements.infoText.style.display = 'none';
    }
}

function simulateLoading(duration) { 
    const startTime = Date.now(); 
    const splashBar = document.querySelector('.loading-bar'); 
    if (!splashBar) { 
        console.error("Elemen .loading-bar tidak ditemukan."); 
        setTimeout(() => { 
            if (elements.splashScreen) { 
                elements.splashScreen.classList.add('hidden'); 
            } 
        }, duration); 
        return; 
    } 
    const updateInterval = 50; 
    const intervalId = setInterval(updateProgress, updateInterval); 
    function updateProgress() { 
        const elapsedTime = Date.now() - startTime; 
        let progress = (elapsedTime / duration) * 100; 
        if (progress >= 100) { 
            progress = 100; 
            clearInterval(intervalId); 
            setTimeout(() => { 
                elements.splashScreen.classList.add('hidden'); 
            }, 500); 
        } 
        splashBar.style.width = `${progress}%`; 
    } 
}

function showSuggestions() { 
    const query = elements.questionInput.value.toLowerCase().trim(); 
    elements.suggestionBox.innerHTML = ''; 
    elements.suggestionBox.classList.remove('visible'); 
    if (query.startsWith('/')) { 
        const commandQuery = query.substring(1); 
        const matchingCommands = slashCommands.filter(cmd => cmd.command.substring(1).startsWith(commandQuery) ); 
        if (matchingCommands.length > 0) { 
            elements.suggestionBox.classList.add('visible'); 
            matchingCommands.forEach(cmd => { 
                const div = document.createElement('div'); 
                div.classList.add('suggestion-item-slash'); 
                div.innerHTML = `<strong>${cmd.command}</strong><span>${cmd.description}</span>`; 
                div.addEventListener('click', () => { 
                    elements.questionInput.value = cmd.command + ' '; 
                    elements.suggestionBox.classList.remove('visible'); 
                    elements.questionInput.focus(); 
                }); 
                elements.suggestionBox.appendChild(div); 
            }); 
        } 
    } else { 
        if (query.length < 2) return; 
        const suggestions = Object.keys(faqDatabase) 
        .filter(key => key.toLowerCase().includes(query)) 
        .slice(0, 5); 
        if (suggestions.length > 0) { 
            elements.suggestionBox.classList.add('visible'); 
            suggestions.forEach(suggestion => { 
                const div = document.createElement('div'); 
                div.classList.add('suggestion-item'); 
                div.innerText = suggestion; 
                div.addEventListener('click', () => { 
                    elements.questionInput.value = suggestion; 
                    elements.suggestionBox.classList.remove('visible'); 
                    askAI(); 
                }); 
                elements.suggestionBox.appendChild(div); 
            }); 
        } 
    } 
}

function findSmartAnswer(question) { 
    const normalized = question.toLowerCase().trim(); 
    const sortedKeys = Object.keys(faqDatabase).sort((a, b) => b.length - a.length); 
    for (const key of sortedKeys) { 
        const normalizedKey = key.toLowerCase().replace("?", ""); 
        if (normalized.includes(normalizedKey)) return faqDatabase[key]; 
    } 
    return null; 
}

function typeWriterEffect(element, text, speed = 0.5) { 
    const parsedHtml = marked.parse(text); 
    let i = 0; 
    element.innerHTML = ''; 
    const tempElement = document.createElement('div'); 
    tempElement.innerHTML = parsedHtml; 
    const textToType = tempElement.innerText; 
    return new Promise(resolve => { 
        function type() { 
            if (i < textToType.length) { 
                element.innerHTML += textToType.charAt(i); 
                i++; 
                setTimeout(type, speed); 
            } else { 
                element.innerHTML = parsedHtml; 
                resolve(); 
            } 
        } 
        type(); 
    }); 
}

function showLoading() { 
    const loadingBubble = document.createElement('div'); 
    loadingBubble.classList.add('chat-bubble', 'ai-bubble', 'typing-indicator', 'fade-in'); 
    loadingBubble.innerHTML = '<span></span><span></span><span></span>'; 
    elements.chatMessages.appendChild(loadingBubble); 
    return loadingBubble; 
}

function stopAI() {
    if (abortController) {
        abortController.abort();
        console.log("Response aborted.");
        elements.stopBtn.style.display = 'none';
        elements.sendBtn.style.display = 'block';
        elements.clearBtnContainer.style.display = 'block';
        const loadingBubble = document.querySelector('.typing-indicator');
        if (loadingBubble) loadingBubble.remove();
    }
    
    if (window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
        document.querySelectorAll('.speak-btn').forEach(btn => {
            btn.classList.remove('fa-stop');
            btn.classList.add('fa-volume-up');
        });
    }
}

function handleSlashCommand(question) { 
    if (!question.startsWith('/')) { 
        return null; 
    } 
    const parts = question.split(' '); 
    const command = parts[0].toLowerCase(); 
    switch (command) { 
        case '/translate': { 
            const toIndex = parts.indexOf('to'); 
            if (toIndex === -1 || toIndex < 2) { 
                return "Error: Invalid format. Use /translate [text] to [language]"; 
            } 
            const textToTranslate = parts.slice(1, toIndex).join(' '); 
            const targetLanguage = parts.slice(toIndex + 1).join(' '); 
            return `Translate the following text to ${targetLanguage}: "${textToTranslate}"`; 
        } 
        case '/summarize': { 
            const textToSummarize = parts.slice(1).join(' '); 
            if (textToSummarize.length < 20) { 
                return "Error: Please provide more text to summarize."; 
            } 
            return `Provide a concise summary of the following text: "${textToSummarize}"`; 
        } 
        case '/rephrase': { 
            const asIndex = parts.indexOf('as'); 
            if (asIndex === -1 || asIndex < 2) { 
                return "Error: Invalid format. Use /rephrase [text] as [tone]"; 
            } 
            const textToRephrase = parts.slice(1, asIndex).join(' '); 
            const tone = parts.slice(asIndex + 1).join(' '); 
            return `Rephrase the following text in a ${tone} tone: "${textToRephrase}"`; 
        } 
        case '/ideate': { 
            const forIndex = parts.indexOf('for'); 
            if (forIndex === -1 || forIndex < 3 || isNaN(parseInt(parts[1]))) { 
                return "Error: Invalid format. Use /ideate [number] ideas for [topic]"; 
            } 
            const number = parts[1]; 
            const topic = parts.slice(forIndex + 1).join(' '); 
            return `Generate ${number} ideas for ${topic}. Present them as a numbered list.`; 
        } 
        case '/fix': { 
            const textToFix = parts.slice(1).join(' '); 
            if (!textToFix) { 
                return "Error: Please provide text to fix. Use /fix [text]"; 
            } 
            return `Proofread and correct any grammatical errors and spelling mistakes in the following text. Only provide the corrected text: "${textToFix}"`; 
        } 
        case '/explain': { 
            const likeIndex = parts.findIndex(part => part.toLowerCase() === "like"); 
            if (likeIndex === -1 || likeIndex < 2) { 
                return "Error: Invalid format. Use /explain [concept] like I'm [audience]"; 
            } 
            const concept = parts.slice(1, likeIndex).join(' '); 
            const audienceIndex = parts.indexOf("I'm") > -1 ? parts.indexOf("I'm") : parts.indexOf("i'm"); 
            if (audienceIndex === -1 || audienceIndex <= likeIndex) { 
                return "Error: Invalid audience format. Use \"like I'm ...\""; 
            } 
            const audience = parts.slice(audienceIndex + 1).join(' '); 
            return `Explain the concept of "${concept}" as if you were talking to a ${audience}.`; 
        } 
        case '/code': { 
            const toIndex = parts.indexOf('to'); 
            if (toIndex === -1 || toIndex < 3) { 
                return "Error: Invalid format. Use /code a [language] function to [description]"; 
            } 
            const language = parts[2]; 
            const description = parts.slice(toIndex + 1).join(' '); 
            return `Write a code snippet in ${language} for the following task: "${description}". Provide only the code, enclosed in a markdown code block.`; 
        } 
        case '/search': { 
            const query = parts.slice(1).join(' '); 
            if (!query) { 
                return "Error: Please provide a search query. Use /search [query]"; 
            } 
            return `Search the web for information about "${query}". Provide a concise summary and, if possible, include relevant links.`; 
        } 
        default: return `Error: Unknown command "${command}". Try /translate or /summarize.`; 
    } 
}

function createAiBubble(text, useInnerHTML = true) {
    const bubble = document.createElement('div');
    bubble.classList.add('chat-bubble', 'ai-bubble', 'fade-in');
    bubble.setAttribute('data-raw-text', text);
    if (useInnerHTML) {
        bubble.innerHTML = `${marked.parse(text)}
                          <i class="fas fa-copy copy-btn" onclick="copyToClipboard(this)"></i>
                          <i class="fas fa-volume-up speak-btn" onclick="speakText(this)"></i>`;
    }
    return bubble;
}

function getLangCodeForSpeech(lang) {
    if (lang === 'en-uk') return 'en-GB';
    if (lang === 'en') return 'en-US';
    if (lang === 'jp') return 'ja-JP';
    if (lang === 'id') return 'id-ID';
    return 'id-ID';
}

function speakText(element) {
    const aiBubble = element.closest('.ai-bubble');
    const textToSpeak = aiBubble.getAttribute('data-raw-text');
    const icon = element;

    if (icon.classList.contains('fa-stop')) {
        window.speechSynthesis.cancel();
        return;
    }

    if (window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
        document.querySelectorAll('.speak-btn').forEach(btn => {
            btn.classList.remove('fa-stop');
            btn.classList.add('fa-volume-up');
        });
    }

    if (!textToSpeak) return;

    const utterance = new SpeechSynthesisUtterance(textToSpeak);
    utterance.lang = getLangCodeForSpeech(currentLanguage);

    utterance.onstart = () => {
        icon.classList.remove('fa-volume-up');
        icon.classList.add('fa-stop');
    };

    utterance.onend = () => {
        icon.classList.remove('fa-stop');
        icon.classList.add('fa-volume-up');
    };

    utterance.onerror = (event) => {
        console.error('SpeechSynthesis Error:', event.error);
        icon.classList.remove('fa-stop');
        icon.classList.add('fa-volume-up');
    };

    window.speechSynthesis.speak(utterance);
}

function copyToClipboard(element) { 
    const aiBubble = element.closest('.ai-bubble'); 
    const textToCopy = aiBubble.getAttribute('data-raw-text'); 
    const formattedText = `${textToCopy}${uiStrings[currentLanguage].copySuffix}`; 
    const tempInput = document.createElement('textarea'); 
    tempInput.value = formattedText; 
    document.body.appendChild(tempInput); 
    tempInput.select(); 
    tempInput.setSelectionRange(0, 99999); 
    document.execCommand('copy'); 
    document.body.removeChild(tempInput); 
    showCopyFeedback(uiStrings[currentLanguage].copyFeedback); 
}

function showCopyFeedback(message) { 
    const feedbackDiv = document.createElement('div'); 
    feedbackDiv.innerText = message; 
    feedbackDiv.style.cssText = ` 
        position: fixed; 
        bottom: 150px; 
        left: 50%; 
        transform: translateX(-50%); 
        background-color: #444; 
        color: #fff; 
        padding: 10px 20px; 
        border-radius: 20px; 
        font-size: 14px; 
        z-index: 200; 
        opacity: 0; 
        transition: opacity 0.5s ease-in-out; 
    `; 
    document.body.appendChild(feedbackDiv); 
    setTimeout(() => { 
        feedbackDiv.style.opacity = 1; 
    }, 10); 
    setTimeout(() => { 
        feedbackDiv.style.opacity = 0; 
        setTimeout(() => feedbackDiv.remove(), 500); 
    }, 2000); 
}

function checkIndicatorPosition() { 
    const connectionStatus = document.getElementById('connectionStatus'); 
    if (!connectionStatus) return; 
    const indicatorRect = connectionStatus.getBoundingClientRect(); 
    const userBubbles = document.querySelectorAll('.user-bubble'); 
    let isOverlapping = false; 
    for (const bubble of userBubbles) { 
        const bubbleRect = bubble.getBoundingClientRect(); 
        const verticalOverlap = indicatorRect.bottom > bubbleRect.top && indicatorRect.top < bubbleRect.bottom; 
        const horizontalOverlap = indicatorRect.right > bubbleRect.left && indicatorRect.right < bubbleRect.right; 
        if (verticalOverlap && horizontalOverlap) { 
            isOverlapping = true; 
            break; 
        } 
    } 
    connectionStatus.classList.toggle('hidden-by-scroll', isOverlapping); 
}

    window.addEventListener('online', updateConnectionStatus);
    window.addEventListener('offline', updateConnectionStatus);
</script>
</body>
</html>
